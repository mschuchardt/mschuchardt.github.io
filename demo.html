<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Lead Conversion Model</title>

<script src="site_libs/jquery-1.12.4/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cerulean.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/htmlwidgets-1.2/htmlwidgets.js"></script>
<script src="site_libs/viz-0.3/viz.js"></script>
<link href="site_libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
<script src="site_libs/grViz-binding-1.0.0/grViz.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="site_libs/datatables-binding-0.4/datatables.js"></script>
<link href="site_libs/dt-core-1.10.16/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="site_libs/dt-core-1.10.16/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="site_libs/dt-core-1.10.16/js/jquery.dataTables.min.js"></script>
<link href="site_libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="site_libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>



<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Matt Schuchardt</a>
</li>
<li>
  <a href="demo.html">
    <span class="fa fa-magic"></span>
     
    Modeling
  </a>
</li>
<li>
  <a href="data.html">
    <span class="fa fa-chart-line"></span>
     
    Visualization
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://www.linkedin.com/in/mattschuchardt/">
    <span class="fa fa-linkedin"></span>
     
  </a>
</li>
<li>
  <a href="mailto:mattschuchardt305@gmail.com">
    <span class="fa fa-envelope"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Lead Conversion Model</h1>
<h3 class="subtitle">Predicting leads likely to convert</h3>

</div>


<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># soql api call ---------</span>
obj.soql &lt;-<span class="st"> </span><span class="kw">c</span>(
           <span class="st">&quot;SELECT Id,</span>
<span class="st">            Title,</span>
<span class="st">            Email,</span>
<span class="st">            LeadSource,</span>
<span class="st">            Product_Service_Interest__c,</span>
<span class="st">            pi__campaign__c,</span>
<span class="st">            pi__score__c, </span>
<span class="st">            pi__first_touch_url__c,</span>
<span class="st">            pi__first_activity__c,</span>
<span class="st">            pi__last_activity__c,</span>
<span class="st">            pi__created_date__c,</span>
<span class="st">            CreatedDate,</span>
<span class="st">            LastModifiedDate,</span>
<span class="st">            LastActivityDate,</span>
<span class="st">            Status,</span>
<span class="st">            IsConverted,</span>
<span class="st">            pi__conversion_date__c,</span>
<span class="st">            ConvertedDate FROM Lead WHERE</span>
<span class="st">            pi__first_activity__c != NULL and</span>
<span class="st">            Status != &#39;Existing Opportunity&#39; and </span>
<span class="st">            pi__created_date__c &gt;= 2016-01-01T00:00:00Z and</span>
<span class="st">            CreatedDate &gt;=  2016-01-01T00:00:00Z&quot;</span>
            ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">str_remove_all</span>(., <span class="st">&quot;</span><span class="ch">\\\n</span><span class="st">&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">str_squish</span>(.)
 
<span class="co"># excute api call</span>
<span class="co"># extract email domain</span>
obj &lt;-<span class="st"> </span><span class="kw">rforcecom.query</span>(session, obj.soql) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">   </span><span class="kw">rforce_df</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">   </span><span class="kw">separate</span>(Email,
            <span class="kw">c</span>(<span class="st">&quot;drop&quot;</span>, <span class="st">&quot;domain&quot;</span>), 
           <span class="dt">sep =</span> <span class="st">&quot;@&quot;</span>,
           <span class="dt">remove =</span> T) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>drop)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#start clock</span>
start.time &lt;-<span class="st"> </span><span class="kw">proc.time</span>()

<span class="co"># feature engineering ----</span>
<span class="co"># create labels</span>
<span class="co"># create indicator variables</span>
<span class="co"># extract email suffix</span>
<span class="co"># create day variables</span>
objs &lt;-<span class="st"> </span>obj <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">label =</span> <span class="kw">case_when</span>(IsConverted <span class="op">==</span><span class="st"> </span>T <span class="op">|</span>
<span class="st">                                 </span>Status <span class="op">==</span><span class="st"> &quot;Qualified&quot;</span> <span class="op">|</span>
<span class="st">                                 </span>Status <span class="op">==</span><span class="st"> &quot;Sales Active&quot;</span> <span class="op">~</span>
<span class="st">                             &quot;Yes&quot;</span>,
                                Status <span class="op">==</span><span class="st"> &quot;Unqualified&quot;</span> <span class="op">&amp;</span>
<span class="st">                                  </span>IsConverted <span class="op">==</span><span class="st"> </span>F <span class="op">~</span><span class="st"> </span>
<span class="st">                                 &quot;No&quot;</span>),
         <span class="dt">label =</span> <span class="kw">factor</span>(label, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>)),
         <span class="dt">PublicDomain =</span> <span class="kw">ifelse</span>(domain <span class="op">%in%</span><span class="st"> </span>public.domains, 
                               <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>),
         <span class="dt">PublicDomain =</span> <span class="kw">factor</span>(PublicDomain),
         <span class="dt">KnownURL =</span> 
           <span class="kw">ifelse</span>(<span class="kw">is.na</span>(pi__first_touch_url__c), <span class="st">&quot;No&quot;</span>,
                  <span class="st">&quot;Yes&quot;</span>),
         <span class="dt">KnownURL =</span> <span class="kw">factor</span>(KnownURL),
         <span class="dt">EmailSuffix =</span>
           <span class="kw">as.character</span>(<span class="kw">str_extract_all</span>(domain, 
                                        <span class="st">&quot;[.][A-z]{2,6}$&quot;</span>)),
          <span class="dt">EmailSuffix =</span><span class="kw">str_remove_all</span>(EmailSuffix, <span class="st">&quot;[.]&quot;</span>),
         <span class="dt">PardotScore =</span> <span class="kw">as.numeric</span>(pi__score__c),
         <span class="dt">Age =</span> 
           <span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.na</span>(ConvertedDate),
                   <span class="kw">as.numeric</span>(ConvertedDate <span class="op">-</span>
<span class="st">                                </span>pi__created_date__c),
                <span class="kw">as.numeric</span>(lubridate<span class="op">::</span><span class="kw">as_date</span>(<span class="kw">Sys.Date</span>()) <span class="op">-</span>
<span class="st">                      </span>pi__created_date__c)),
         <span class="dt">Age =</span> <span class="kw">ifelse</span>(Age <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, Age),
         <span class="dt">LastActivity =</span> 
           <span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.na</span>(ConvertedDate),
                    <span class="kw">as.numeric</span>(ConvertedDate <span class="op">-</span><span class="st"> </span>
<span class="st">                                 </span>pi__last_activity__c),
                <span class="kw">as.numeric</span>(lubridate<span class="op">::</span><span class="kw">as_date</span>(<span class="kw">Sys.Date</span>()) <span class="op">-</span>
<span class="st">                              </span>pi__last_activity__c)),  
         <span class="dt">LastActivity =</span>
           <span class="kw">ifelse</span>(LastActivity <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, LastActivity),
         <span class="dt">ActivityDays =</span> 
           <span class="kw">as.numeric</span>(pi__last_activity__c <span class="op">-</span>
<span class="st">                        </span>pi__first_activity__c),
         <span class="dt">ActivityDays =</span> 
           <span class="kw">ifelse</span>(ActivityDays <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, ActivityDays)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>domain)

<span class="co"># count leads -----</span>
objs.count &lt;-<span class="st"> </span>objs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Group =</span> <span class="kw">case_when</span>(<span class="kw">is.na</span>(label) <span class="op">~</span><span class="st"> &quot;Open&quot;</span>,
                           label <span class="op">==</span><span class="st"> &quot;Yes&quot;</span> <span class="op">~</span><span class="st"> &quot;Converted&quot;</span>,
                           label <span class="op">==</span><span class="st"> &quot;No&quot;</span> <span class="op">~</span><span class="st"> &quot;Unqualified&quot;</span>),
         <span class="dt">Group =</span> <span class="kw">factor</span>(Group, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;Converted&quot;</span>,
                                          <span class="st">&quot;Unqualified&quot;</span>,
                                          <span class="st">&quot;Open&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(Group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">spread</span>(Group, n)

<span class="co"># start and end days</span>
objs.start &lt;-<span class="st"> </span>obj <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Id,
         CreatedDate,
         pi__created_date__c) <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st">  </span><span class="kw">gather</span>(key, Date, <span class="op">-</span><span class="kw">c</span>(Id)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>key) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(Date <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(Date, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>()

objs.end &lt;-<span class="st"> </span>obj <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Id,
         pi__conversion_date__c, 
         ConvertedDate, 
         LastActivityDate, 
         pi__last_activity__c) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(key, Date, <span class="op">-</span><span class="kw">c</span>(Id)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>key) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(Date <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(Date, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">inner_join</span>(objs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">               </span><span class="kw">select</span>(Id, label)) 

<span class="co"># conversions ----</span>
<span class="co"># cumulative conversions</span>
event.count &lt;-<span class="st"> </span>objs.start <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">no_event =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(objs.end) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">no_event =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(no_event), <span class="dv">0</span>, no_event)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(Date) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">label =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(label), <span class="st">&quot;Open&quot;</span>,
                        <span class="kw">as.character</span>(label))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">event =</span> <span class="kw">ifelse</span>(label <span class="op">==</span><span class="st"> &quot;Yes&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>),
         <span class="dt">event_not =</span> <span class="kw">ifelse</span>(label <span class="op">==</span><span class="st"> &quot;No&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">.n =</span> <span class="kw">cumsum</span>(no_event),
         <span class="dt">.n_events =</span> <span class="kw">cumsum</span>(event),
         <span class="dt">.n_events_not =</span> <span class="kw">cumsum</span>(event_not),
         <span class="dt">.pecent_tested =</span> <span class="kw">percent_rank</span>(.n),
         <span class="dt">.percent_found =</span> <span class="kw">percent_rank</span>(.n_events))

<span class="co"># conversion rate by year</span>
conversions &lt;-<span class="st"> </span>event.count <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Year =</span> lubridate<span class="op">::</span><span class="kw">year</span>(Date)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(Year, label) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">Opportunities =</span> <span class="kw">n_distinct</span>(Id)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(Year) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Percent =</span> Opportunities <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(Opportunities)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(Year <span class="op">&lt;</span><span class="st"> </span><span class="dv">2020</span>)

<span class="co"># wide conversion rate</span>
conversion.rate &lt;-<span class="st"> </span>conversions <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Year, label, Opportunities) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">spread</span>(label, Opportunities) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Percent =</span> Yes <span class="op">/</span><span class="st"> </span>(Yes <span class="op">+</span><span class="st"> </span>No <span class="op">+</span><span class="st"> </span>Open))

<span class="co"># compute overall conversion rate</span>
overall.rate &lt;-<span class="st"> </span><span class="kw">sum</span>(conversion.rate<span class="op">$</span>Yes, <span class="dt">na.rm =</span> T) <span class="op">/</span>
<span class="st">  </span>(<span class="kw">sum</span>(conversion.rate<span class="op">$</span>Yes, <span class="dt">na.rm =</span> T) <span class="op">+</span><span class="st"> </span>
<span class="st">     </span><span class="kw">sum</span>(conversion.rate<span class="op">$</span>No, <span class="dt">na.rm =</span> T) <span class="op">+</span>
<span class="st">     </span><span class="kw">sum</span>(conversion.rate<span class="op">$</span>Open, <span class="dt">na.rm =</span> T))</code></pre></div>
<div id="leads" class="section level1 tabset">
<h1>Leads</h1>
<p>526 leads have been loaded to Salesforce since January 2016.<br />
44% have converted or were flagged as unqualified.</p>
<p>74 known conversions and 155 unqualified leads were used to train a classification model to predict conversion probabilities for the 297 open leads.</p>
<div id="lead-status" class="section level2">
<h2>Lead Status</h2>
<p>297 open leads</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># plot lead status</span>
objs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Year =</span>
          lubridate<span class="op">::</span><span class="kw">year</span>(pi__last_activity__c)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(Year))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Status),
           <span class="dt">color =</span> <span class="st">&quot;#FFFFFF&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Qualified&quot;</span> =<span class="st"> &quot;#377EB8&quot;</span>,
                                <span class="st">&quot;Sales Active&quot;</span> =<span class="st"> &quot;#08519C&quot;</span>,
                                <span class="st">&quot;Open&quot;</span> =<span class="st">  &quot;#4DAF4A&quot;</span>,
                                <span class="st">&quot;Unqualified&quot;</span> =<span class="st"> &quot;#E41A1C&quot;</span>,
                                <span class="st">&quot;Contacted&quot;</span> =<span class="st"> &quot;#A1D99B&quot;</span>,
                                <span class="st">&quot;Marketing F/U&quot;</span> =<span class="st"> &quot;#74C476&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="ot">NULL</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span> 
          <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                       <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Lead Status by Last Activity Year&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Leads&quot;</span>,
       <span class="dt">x =</span> <span class="st">&quot;Year of Last Activity&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span>
          <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                       <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>))</code></pre></div>
<p><img src="demo_files/figure-html/statusPlot-1.png" width="576" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># average days between conversions</span>
event.days &lt;-<span class="st"> </span>event.count <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(Id <span class="op">%in%</span><span class="st"> </span>objs[<span class="op">!</span><span class="kw">is.na</span>(objs<span class="op">$</span>label),]<span class="op">$</span>Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(Date, <span class="dt">.by_group =</span> T) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">days =</span> <span class="kw">difftime</span>(Date,
                         <span class="kw">lag</span>(Date),
                         <span class="dt">units =</span> <span class="st">&quot;days&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">           </span><span class="kw">as.numeric</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(no_event <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span>
<span class="st">           </span><span class="op">!</span><span class="kw">is.na</span>(days)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Year =</span> lubridate<span class="op">::</span><span class="kw">year</span>(Date))

per.month &lt;-<span class="st"> </span>event.count <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Month =</span> lubridate<span class="op">::</span><span class="kw">floor_date</span>(Date, <span class="st">&quot;month&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(Month) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">opened =</span> <span class="kw">sum</span>(no_event),
            <span class="dt">converted =</span> <span class="kw">sum</span>(event)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(key, value, <span class="op">-</span>Month) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(key) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">round</span>(<span class="kw">mean</span>(value)))</code></pre></div>
</div>
<div id="conversion-rate" class="section level2">
<h2>Conversion Rate</h2>
<p>14 leads opened and 2 leads closed per month.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># plot conversion rate</span>
conversion.rate <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(Year, Percent))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Year),
           <span class="dt">color =</span> <span class="st">&quot;#FFFFFF&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">paste0</span>(<span class="kw">round</span>(Percent <span class="op">*</span><span class="st"> </span><span class="dv">100</span>), <span class="st">&quot;%&quot;</span>),
                <span class="dt">y =</span> Percent <span class="op">-</span><span class="st"> </span><span class="fl">0.01</span>),
            <span class="dt">size =</span> <span class="dv">6</span>,
            <span class="dt">color =</span> <span class="st">&quot;#FFFFFF&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">paste0</span>(<span class="st">&quot;Average conversion rate: &quot;</span>, 
                      <span class="kw">round</span>(<span class="kw">mean</span>(conversion.rate<span class="op">$</span>Percent) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>),
                        <span class="st">&quot;%&quot;</span>),
       <span class="dt">x =</span> <span class="st">&quot;Last Activity Year&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Percent of Leads by Year&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_continuous</span>(<span class="dt">labels =</span> <span class="kw">as.character</span>(conversion.rate<span class="op">$</span>Year),
                        <span class="dt">breaks =</span> conversion.rate<span class="op">$</span>Year)<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>))</code></pre></div>
<p><img src="demo_files/figure-html/conversionPlot-1.png" width="576" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># variable significance -----------</span>
<span class="co"># fit an intercept only logistic model</span>
<span class="co"># use add1 to fit single variable models for other predictors</span>
<span class="co"># select predictors that significantly improve deviance</span>
var_sig &lt;-<span class="st"> </span><span class="cf">function</span>(df, vrs){
  .scp &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>(<span class="st">&quot;~&quot;</span>, <span class="kw">paste</span>(vrs, <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>)))
  df &lt;-<span class="st"> </span><span class="kw">mutate</span>(df, <span class="dt">label =</span> <span class="kw">ifelse</span>(label <span class="op">==</span><span class="st"> &quot;Yes&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>))
  mdl &lt;-<span class="st"> </span><span class="kw">glm</span>(label <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,
             <span class="dt">family =</span> <span class="kw">binomial</span>(<span class="dt">link =</span> <span class="st">&quot;logit&quot;</span>),
             <span class="dt">data =</span> df)
  add &lt;-<span class="st"> </span><span class="kw">add1</span>(mdl,
              <span class="dt">scope =</span> .scp) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">rownames_to_column</span>(<span class="st">&quot;variable&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">dev.imp =</span> mdl<span class="op">$</span>deviance <span class="op">-</span><span class="st"> </span>Deviance,
           <span class="dt">ptst =</span> <span class="dv">1</span><span class="op">-</span><span class="kw">pchisq</span>(dev.imp, <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(variable <span class="op">%in%</span><span class="st"> </span>vrs) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(ptst <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.01</span>) 
  out &lt;-<span class="st"> </span>add<span class="op">$</span>variable
  <span class="kw">rm</span>(mdl, df, .scp, add)
  <span class="kw">gc</span>()
  <span class="kw">return</span>(out)
}

<span class="co"># variable relevance ----</span>
<span class="co"># compare variable importance to importance achievable at random</span>
<span class="co"># via random forest</span>
<span class="co"># select variables deemed relevant</span>
var_rel &lt;-<span class="st"> </span><span class="cf">function</span>(df, form){
  bor &lt;-<span class="st"> </span><span class="kw">Boruta</span>(form, df) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">TentativeRoughFix</span>()
  out &lt;-<span class="st"> </span><span class="kw">getSelectedAttributes</span>(bor)
  <span class="kw">return</span>(out)
}

<span class="co"># variable importance ----</span>
<span class="co"># use caret to calculate variable importance</span>
<span class="co"># select important variables</span>
var_imp &lt;-<span class="st"> </span><span class="cf">function</span>(df, .form){
  mdl &lt;-<span class="st"> </span>caret<span class="op">::</span><span class="kw">train</span>(.form, <span class="dt">data =</span> df, <span class="dt">method =</span> <span class="st">&quot;glmnet&quot;</span>)
  imp &lt;-<span class="st"> </span>caret<span class="op">::</span><span class="kw">varImp</span>(mdl)
  imp &lt;-<span class="st"> </span>imp<span class="op">$</span>importance <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">rownames_to_column</span>(<span class="st">&quot;vrs&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(Overall <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)
  out &lt;-<span class="st"> </span>imp<span class="op">$</span>vrs
  <span class="kw">return</span>(out)
}

<span class="co"># combined variable importance ----</span>
final_imp &lt;-<span class="st"> </span><span class="cf">function</span>(df, vrs){
  form &lt;-<span class="st"> </span><span class="kw">as_formula</span>(vrs)
  .scp &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>(<span class="st">&quot;~&quot;</span>, <span class="kw">paste</span>(vrs, <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>)))
  var.imp &lt;-<span class="st"> </span>caret<span class="op">::</span><span class="kw">train</span>(form, <span class="dt">data =</span> df, <span class="dt">method =</span> <span class="st">&quot;glmnet&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>caret<span class="op">::</span><span class="kw">varImp</span>()
  var.imp &lt;-<span class="st"> </span>var.imp<span class="op">$</span>importance <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">rownames_to_column</span>(<span class="st">&quot;variable&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">select</span>(variable, <span class="dt">value =</span> Overall)
  var.rel &lt;-<span class="st"> </span><span class="kw">Boruta</span>(form, df) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">TentativeRoughFix</span>()
  var.rel &lt;-<span class="st"> </span>var.rel<span class="op">$</span>ImpHistory <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">gather</span>(variable, value) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.finite</span>(value), <span class="dv">0</span>, value)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(variable) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">mean</span>(value)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="kw">is.finite</span>(value)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">filter</span>(variable <span class="op">%in%</span><span class="st"> </span>vrs)
  dat &lt;-<span class="st"> </span><span class="kw">mutate</span>(df, <span class="dt">label =</span> <span class="kw">ifelse</span>(label <span class="op">==</span><span class="st"> &quot;Yes&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>))
  mdl &lt;-<span class="st"> </span><span class="kw">glm</span>(label <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,
             <span class="dt">family =</span> <span class="kw">binomial</span>(<span class="dt">link =</span> <span class="st">&quot;logit&quot;</span>),
             <span class="dt">data =</span> dat)
  add &lt;-<span class="st"> </span><span class="kw">add1</span>(mdl,
              <span class="dt">scope =</span> .scp) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">rownames_to_column</span>(<span class="st">&quot;variable&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">dev.imp =</span> mdl<span class="op">$</span>deviance <span class="op">-</span><span class="st"> </span>Deviance,
                  <span class="dt">ptst =</span> <span class="dv">1</span><span class="op">-</span><span class="kw">pchisq</span>(dev.imp, <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">filter</span>(variable <span class="op">%in%</span><span class="st"> </span>vrs) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">select</span>(variable, <span class="dt">value =</span> dev.imp)
  out &lt;-<span class="st"> </span>var.rel <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">selector =</span> <span class="st">&quot;Relevance&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">bind_rows</span>(var.imp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">selector =</span> <span class="st">&quot;Importance&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">bind_rows</span>(add <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">selector =</span> <span class="st">&quot;Significance&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(selector) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">value =</span> value <span class="op">/</span><span class="st"> </span><span class="kw">max</span>(value)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">ungroup</span>()
  <span class="kw">return</span>(out)
}

<span class="co"># level aggregation ----</span>
<span class="co"># most freq token</span>
token_freq &lt;-<span class="st"> </span><span class="cf">function</span>(x){
tkns &lt;-<span class="st"> </span>tokenizers<span class="op">::</span><span class="kw">tokenize_word_stems</span>(x,
                                        <span class="dt">stopwords =</span> 
                                          <span class="kw">c</span>(<span class="st">&quot;of&quot;</span>, <span class="st">&quot;the&quot;</span>, <span class="st">&quot;and&quot;</span>))
tkn.freq &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="kw">unlist</span>(tkns))
<span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">seq_along</span>(tkns)){
  tkns[[i]] &lt;-<span class="st"> </span><span class="kw">names</span>(<span class="kw">which.max</span>(tkn.freq[tkns[[i]]]))[[<span class="dv">1</span>]]
  tkns[[i]] &lt;-<span class="st"> </span><span class="kw">ifelse</span>(tkns[[i]] <span class="op">==</span><span class="st"> &quot;NA&quot;</span>, <span class="ot">NA</span>, tkns[[i]])
  tkns
}
<span class="kw">return</span>(<span class="kw">unlist</span>(tkns))
}

<span class="co"># bayes ttest ----</span>
<span class="co"># workhorse ----</span>
<span class="co"># from http://people.idsia.ch/~marco/papers/2017jmlr-tests.pdf</span>
correlatedBayesianTtest &lt;-<span class="st"> </span><span class="cf">function</span>(diff_a_b,rho,rope_min,rope_max){
  <span class="cf">if</span> (rope_max <span class="op">&lt;</span><span class="st"> </span>rope_min){
    <span class="kw">stop</span>(<span class="st">&quot;rope_max should be larger than rope_min&quot;</span>)
  }
  
  delta &lt;-<span class="st"> </span><span class="kw">mean</span>(diff_a_b)
  n &lt;-<span class="st"> </span><span class="kw">length</span>(diff_a_b)
  df &lt;-<span class="st"> </span>n<span class="op">-</span><span class="dv">1</span>
  stdX &lt;-<span class="st"> </span><span class="kw">sd</span>(diff_a_b)
  sp &lt;-<span class="st"> </span><span class="kw">sd</span>(diff_a_b)<span class="op">*</span><span class="kw">sqrt</span>(<span class="dv">1</span><span class="op">/</span>n <span class="op">+</span><span class="st"> </span>rho<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>rho))
  p.left &lt;-<span class="st"> </span><span class="kw">pt</span>((rope_min <span class="op">-</span><span class="st"> </span>delta)<span class="op">/</span>sp, df)
  p.rope &lt;-<span class="st"> </span><span class="kw">pt</span>((rope_max <span class="op">-</span><span class="st"> </span>delta)<span class="op">/</span>sp, df)<span class="op">-</span>p.left
  results &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">&#39;left&#39;</span>=p.left,<span class="st">&#39;rope&#39;</span>=p.rope,
                  <span class="st">&#39;right&#39;</span>=<span class="dv">1</span><span class="op">-</span>p.left<span class="op">-</span>p.rope)
  <span class="kw">return</span> (results)
}

<span class="co"># prep ------</span>
<span class="co"># by creating ab list</span>
pair_cross &lt;-<span class="st"> </span><span class="cf">function</span>(df, .grp){
  crss &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;a&quot;</span> =<span class="st"> </span>df[[.grp]],
                         <span class="st">&quot;b&quot;</span> =<span class="st"> </span><span class="kw">c</span>(df[[.grp]][<span class="dv">2</span><span class="op">:</span><span class="kw">nrow</span>(df)], <span class="ot">NA</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(b))
  <span class="kw">return</span>(crss)
}

<span class="co"># compute differences ----</span>
<span class="co"># and apply bayesian ttest  </span>
corr_bayes_test &lt;-<span class="st"> </span><span class="cf">function</span>(x, 
                            df, 
                            flds, 
                            best,
                            <span class="dt">.ropemin =</span> <span class="op">-</span><span class="fl">0.01</span>,
                            <span class="dt">.ropemax =</span> <span class="fl">0.01</span>){
  out &lt;-<span class="st"> </span><span class="kw">correlatedBayesianTtest</span>(df[[best]] <span class="op">-</span><span class="st"> </span>df[[x]],
                                 <span class="dt">rho =</span> flds,
                                 <span class="dt">rope_min =</span> .ropemin,
                                 <span class="dt">rope_max =</span> .ropemax)
  <span class="kw">return</span>(out)
}

<span class="co"># execute ----</span>
<span class="co"># for entire ab list and label results</span>
bayes_ttest &lt;-<span class="st"> </span><span class="cf">function</span>(df.rank, .grp, df.summary, .flds){
 crs &lt;-<span class="st"> </span><span class="kw">pair_cross</span>(df.rank, .grp)
 a.b &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">nrow</span>(crs))
 <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(crs)){
   a.b[[i]] &lt;-<span class="st"> </span><span class="kw">corr_bayes_test</span>(<span class="dt">x =</span> crs[[i,<span class="dv">1</span>]],
                               <span class="dt">df =</span> df.summary,
                               <span class="dt">flds =</span> <span class="dv">1</span><span class="op">/</span>.flds,
                               <span class="dt">best =</span> crs[[i,<span class="dv">2</span>]])
 <span class="kw">names</span>(a.b[[i]]) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">paste</span>(crs[[i,<span class="dv">1</span>]], 
                                  <span class="st">&quot;&gt;&quot;</span>,
                                  crs[[i,<span class="dv">2</span>]]),
                            <span class="kw">paste</span>(crs[[i,<span class="dv">1</span>]],
                                  <span class="st">&quot;=&quot;</span>,
                                  crs[[i,<span class="dv">2</span>]]),
                            <span class="kw">paste</span>(crs[[i,<span class="dv">1</span>]], 
                                  <span class="st">&quot;&lt;&quot;</span>,
                                  crs[[i,<span class="dv">2</span>]]))
  a.b[[i]] &lt;-<span class="st"> </span>a.b[[i]] <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">as_tibble</span>()
  a.b[[i]]
 }
 <span class="kw">return</span>(a.b)
}

<span class="co"># helper functions ----</span>
<span class="co"># quiet fits ----</span>
<span class="co"># don&#39;t print model details to console</span>
q_f &lt;-<span class="st"> </span><span class="kw">quietly</span>(fit)

<span class="co"># intersect 3 vectors</span>
triple_u &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, z){
  p1 &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;vrs&quot;</span> =<span class="st"> </span><span class="kw">c</span>(x,y,z))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">unique</span>()
  out &lt;-<span class="st"> </span><span class="kw">unique</span>(p1<span class="op">$</span>vrs)
  <span class="kw">return</span>(out)
}

<span class="co"># union 3 vectors</span>
triple_inter &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, z){
  p1 &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;vrs&quot;</span> =<span class="st"> </span><span class="kw">c</span>(x,y,z))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">n =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(vrs) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(<span class="kw">n</span>() <span class="op">==</span><span class="st"> </span><span class="dv">3</span>)
  out &lt;-<span class="st"> </span><span class="kw">unique</span>(p1<span class="op">$</span>vrs)
  <span class="kw">return</span>(out)
}

<span class="co"># parsnip formula fitter ----</span>
<span class="co"># reorder arguments to use on list columns</span>
prs_form &lt;-<span class="st"> </span><span class="cf">function</span>(df, .form, prs){
  out &lt;-<span class="st"> </span><span class="kw">q_f</span>(prs, .form, df)[[<span class="st">&quot;result&quot;</span>]]
  <span class="kw">return</span>(out)
}

<span class="co"># recipe prepper ----</span>
<span class="co"># reorder arguments to use on list columns</span>
df_prep &lt;-<span class="st"> </span><span class="cf">function</span>(df, rec){
  out &lt;-<span class="st"> </span><span class="kw">prep</span>(rec, df, <span class="dt">strings_as_factors =</span> F)
  <span class="kw">return</span>(out)
}

<span class="co"># predictor ----</span>
<span class="co"># reorder arguments to use on list columns</span>
df_pred &lt;-<span class="st"> </span><span class="cf">function</span>(df, .fit, .type){
  out &lt;-<span class="st"> </span><span class="kw">predict</span>(.fit, <span class="dt">new_data =</span> df, <span class="dt">type =</span> .type)
  <span class="kw">return</span>(out)
}

<span class="co"># formula creator ----</span>
<span class="co"># create formula from vector of variables</span>
as_formula &lt;-<span class="st"> </span><span class="cf">function</span>(.vrs, <span class="dt">y.var =</span> <span class="st">&quot;label&quot;</span>){
  out &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>(y.var, <span class="st">&quot;~&quot;</span>,
                          <span class="kw">paste</span>(.vrs, <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>)))
  <span class="kw">return</span>(out)
}

<span class="co"># plot lines to separate folds  </span>
plot.grid &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;grid&quot;</span> =<span class="st"> </span><span class="kw">seq</span>(<span class="fl">1.5</span>, <span class="fl">4.5</span>, <span class="dv">1</span>)))

<span class="co"># zero row data.frame to use as default argument  </span>
zero.rw &lt;-<span class="st"> </span>plot.grid[<span class="dv">0</span>,]

<span class="co"># prose for ab test results  </span>
prose_title &lt;-<span class="st"> </span><span class="cf">function</span>(a.b, .type, <span class="dt">.same =</span> zero.rw){
  <span class="cf">if</span>(a.b[<span class="dv">1</span>,]<span class="op">$</span>prob <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.7</span>){
    <span class="kw">paste0</span>(<span class="st">&quot;The probability &quot;</span>,
           a.b[<span class="dv">1</span>, ]<span class="op">$</span>better,
           <span class="st">&quot; is the best &quot;</span>,
           .type,
           <span class="st">&quot; is &quot;</span>,
           <span class="kw">round</span>(a.b[<span class="dv">1</span>, ]<span class="op">$</span>prob,<span class="dv">2</span>)<span class="op">*</span><span class="dv">100</span>,
           <span class="st">&quot;%&quot;</span>)
  }<span class="cf">else</span>{
    <span class="cf">if</span>(<span class="kw">nrow</span>(.same) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>){
      <span class="kw">paste0</span>(a.b[<span class="dv">1</span>, ]<span class="op">$</span>than,
             <span class="st">&quot; selects &quot;</span>,
             <span class="kw">round</span>((.same[<span class="dv">1</span>,]<span class="op">$</span>than.vrs<span class="op">/</span>.same[<span class="dv">1</span>,]<span class="op">$</span>better.vrs) <span class="op">*</span><span class="dv">100</span>),
             <span class="st">&quot;% fewer features than &quot;</span>,
             a.b[<span class="dv">1</span>, ]<span class="op">$</span>better,
          <span class="st">&quot;</span><span class="ch">\n</span><span class="st">and the probability it performs as well or better is &quot;</span>,
             <span class="kw">round</span>(.same<span class="op">$</span>less[<span class="dv">1</span>],<span class="dv">2</span>)<span class="op">*</span><span class="dv">100</span>,
             <span class="st">&quot;%&quot;</span>)
    }<span class="cf">else</span>{
      <span class="kw">paste0</span>(<span class="st">&quot;The probability &quot;</span>,
             a.b[<span class="dv">1</span>, ]<span class="op">$</span>better,
             <span class="st">&quot; performs as well or better</span><span class="ch">\n</span><span class="st">than &quot;</span>,
             a.b[<span class="dv">1</span>, ]<span class="op">$</span>than,
             <span class="st">&quot; is &quot;</span>,
             <span class="kw">round</span>(a.b<span class="op">$</span>combined[<span class="dv">1</span>],<span class="dv">2</span>)<span class="op">*</span><span class="dv">100</span>,
             <span class="st">&quot;%&quot;</span>)
    }
  }
}

metric_benchmark &lt;-<span class="st"> </span><span class="cf">function</span>(.met, .est){
  out &lt;-<span class="st"> </span><span class="kw">case_when</span>(.met <span class="op">==</span><span class="st"> &quot;j_index&quot;</span> <span class="op">~</span><span class="st">  </span>.est <span class="op">/</span><span class="st"> </span><span class="fl">0.5</span>,
                   .met <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;detection_prevalence&quot;</span>, 
                               <span class="st">&quot;f_meas&quot;</span>, 
                               <span class="st">&quot;kap&quot;</span>,
                               <span class="st">&quot;mcc&quot;</span>) <span class="op">~</span><span class="st"> </span>.est <span class="op">/</span><span class="st"> </span><span class="fl">0.6</span>,
                  .met <span class="op">==</span><span class="st"> &quot;mn_log_loss&quot;</span> <span class="op">~</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.est) <span class="op">/</span><span class="st"> </span><span class="fl">0.614</span>,
                  .met <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;gain_capture&quot;</span>,
                              <span class="st">&quot;pr_auc&quot;</span>) <span class="op">~</span><span class="st"> </span>.est <span class="op">/</span><span class="st"> </span><span class="fl">0.7</span>,
                  .met <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;accuracy&quot;</span>, 
                              <span class="st">&quot;bal_accuracy&quot;</span>,
                              <span class="st">&quot;npv&quot;</span>,
                              <span class="st">&quot;ppv&quot;</span>,
                              <span class="st">&quot;precision&quot;</span>,
                              <span class="st">&quot;recall&quot;</span>,
                              <span class="st">&quot;roc_auc&quot;</span>,
                              <span class="st">&quot;sens&quot;</span>,
                              <span class="st">&quot;spec&quot;</span>) <span class="op">~</span><span class="st"> </span>.est <span class="op">/</span><span class="st"> </span><span class="fl">0.8</span>)
  <span class="kw">return</span>(out)
  }

plot_folds &lt;-<span class="st"> </span><span class="cf">function</span>(df, .tlt, .sbtlt){
  p &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> </span>metric<span class="op">$</span>.metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(id2, 
               .estimate, 
               <span class="dt">group =</span> <span class="kw">fct_rev</span>(<span class="kw">fct_reorder</span>(model,
                                           .estimate,
                                           <span class="dt">.fun =</span> mean)),
               <span class="dt">color =</span> <span class="kw">fct_rev</span>(<span class="kw">fct_reorder</span>(model,
                                           .estimate,
                                           <span class="dt">.fun =</span> mean))))<span class="op">+</span>
<span class="st">    </span><span class="kw">stat_summary</span>(<span class="dt">fun.y =</span> <span class="st">&quot;max&quot;</span>,
                <span class="dt">geom =</span> <span class="st">&quot;point&quot;</span>,
                <span class="dt">shape =</span> <span class="dv">95</span>,
                <span class="dt">size =</span> <span class="fl">2.5</span>,
                <span class="dt">stroke =</span> <span class="dv">4</span>,
                <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="fl">0.9</span>))<span class="op">+</span>
<span class="st">    </span><span class="kw">stat_summary</span>(<span class="dt">fun.y =</span> <span class="st">&quot;min&quot;</span>,
                <span class="dt">geom =</span> <span class="st">&quot;point&quot;</span>,
                <span class="dt">shape =</span> <span class="dv">95</span>,
                <span class="dt">size =</span> <span class="dv">4</span>,
                <span class="dt">stroke =</span> <span class="dv">4</span>,
                <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="fl">0.9</span>))<span class="op">+</span>
<span class="st">    </span><span class="kw">stat_summary</span>(<span class="dt">fun.data =</span> <span class="st">&quot;median_hilow&quot;</span>,
                <span class="dt">geom =</span> <span class="st">&quot;linerange&quot;</span>,
                <span class="dt">size =</span> .<span class="dv">75</span>,
                <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>,
                <span class="dt">linetype =</span> <span class="dv">3</span>,
                <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="fl">0.9</span>))<span class="op">+</span>
<span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">data =</span> plot.grid, <span class="kw">aes</span>(<span class="dt">xintercept =</span> grid),
               <span class="dt">color =</span> <span class="st">&quot;grey50&quot;</span>,
               <span class="dt">size =</span> <span class="fl">0.25</span>)<span class="op">+</span>
<span class="st">    </span><span class="kw">stat_summary</span>(<span class="dt">fun.data =</span> <span class="st">&quot;mean_cl_boot&quot;</span>,
                 <span class="dt">geom =</span> <span class="st">&quot;line&quot;</span>,
                 <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="fl">0.9</span>))<span class="op">+</span>
<span class="st">    </span><span class="kw">stat_summary</span>(<span class="dt">fun.data =</span> <span class="st">&quot;mean_cl_boot&quot;</span>,
                 <span class="dt">geom =</span> <span class="st">&quot;point&quot;</span>,
                 <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="fl">0.9</span>))<span class="op">+</span>
<span class="st">    </span><span class="kw">guides</span>(<span class="dt">color =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="ot">NULL</span>))<span class="op">+</span>
<span class="st">    </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>)<span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">paste</span>(.tlt),
         <span class="dt">subtitle =</span> <span class="kw">paste</span>(.sbtlt),
         <span class="dt">x =</span> <span class="ot">NULL</span>,
         <span class="dt">y =</span> <span class="kw">paste</span>(metric<span class="op">$</span>metric))<span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">panel.background =</span>
           <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="ot">NA</span>,
                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
          <span class="dt">legend.key =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>))
  <span class="kw">print</span>(p)
}</code></pre></div>
</div>
</div>
<div id="methodology" class="section level1 tabset">
<h1>Methodology</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># table of nice model names ----</span>
model.labels &lt;-<span class="st"> </span><span class="kw">tribble</span>(
  <span class="op">~</span>model, <span class="op">~</span>long, <span class="op">~</span>type,
  <span class="st">&quot;GLM&quot;</span>, <span class="st">&quot;Logistic Regression&quot;</span>, <span class="st">&quot;General linear model&quot;</span>,
  <span class="st">&quot;RF&quot;</span>, <span class="st">&quot;Random Forest&quot;</span>, <span class="st">&quot;Bagged ensemble of decision trees&quot;</span>,
  <span class="st">&quot;SVM&quot;</span>, <span class="st">&quot;Support Vector Machine&quot;</span>, <span class="st">&quot;Kernelized linear approximation&quot;</span>,
  <span class="st">&quot;XGB&quot;</span>, <span class="st">&quot;Xtreme Gradient Boosting&quot;</span>, 
  <span class="st">&quot;Boosted ensemble of decision trees&quot;</span>)

<span class="co"># table of feature selectors ----</span>
feature.selectors &lt;-<span class="st"> </span><span class="kw">tribble</span>(
  <span class="op">~</span>Name, <span class="op">~</span>Details,
  <span class="st">&quot;All&quot;</span>, <span class="st">&quot;Filters for correlation, colinearity and variance&quot;</span>,
  <span class="st">&quot;Importance&quot;</span>, 
  <span class="st">&quot;Absolute value of coefficents from fitted glmnet model&quot;</span>,
  <span class="st">&quot;Relevance&quot;</span>, <span class="st">&quot;Importance versus importance achievable at random&quot;</span>,
  <span class="st">&quot;Significance&quot;</span>, 
  <span class="st">&quot;Significant improvement over intercept only model&quot;</span>,
  <span class="st">&quot;Exclusive&quot;</span>,
  <span class="st">&quot;Variables in Importance &amp; Relevance &amp; Significance selections&quot;</span>,
  <span class="st">&quot;Inclusive&quot;</span>, 
  <span class="st">&quot;Variables in Importance or Relevance or Significance selections&quot;</span>
  )

<span class="co"># table of metrics ----</span>
metric.table &lt;-<span class="st"> </span><span class="kw">tribble</span>(
  <span class="op">~</span>.metric, <span class="op">~</span>metric, <span class="op">~</span>details,
  <span class="st">&quot;f_meas&quot;</span>, <span class="st">&quot;F1 Score&quot;</span>, <span class="st">&quot;combination of precision and recall&quot;</span>,
  <span class="st">&quot;j_index&quot;</span>, <span class="st">&quot;Youden&#39;s J&quot;</span>, <span class="st">&quot;sensitivity + specificity - 1&quot;</span>,
  <span class="st">&quot;mcc&quot;</span>, <span class="st">&quot;Matthew`s Correlation&quot;</span>, 
  <span class="kw">paste</span>(<span class="st">&quot;correlation coefficient between&quot;</span>,
        <span class="st">&quot;observed and predicted classifications&quot;</span>),
  <span class="st">&quot;kap&quot;</span>, <span class="st">&quot;Cohen&#39;s Kappa&quot;</span>, <span class="st">&quot;normalized accuracy measure&quot;</span>,
  <span class="st">&quot;mn_log_loss&quot;</span>, <span class="st">&quot;Log Loss&quot;</span>,
  <span class="kw">paste</span>(<span class="st">&quot;accuracy measure accounting&quot;</span>,
          <span class="st">&quot;for certainty of prediction&quot;</span>),
  <span class="st">&quot;accuracy&quot;</span>, <span class="st">&quot;Accuracy&quot;</span>, <span class="st">&quot;percent of correct classifications&quot;</span>,
  <span class="st">&quot;bal_accuracy&quot;</span>, <span class="st">&quot;Balanced Accuracy&quot;</span>,
  <span class="st">&quot;average of sensitivity and specificity&quot;</span>,
  <span class="st">&quot;detection_prevalence&quot;</span>, <span class="st">&quot;Detection Prevalence&quot;</span>, 
  <span class="kw">paste</span>(<span class="st">&quot;the number of predicted&quot;</span>,
        <span class="st">&quot;positive events divided&quot;</span>,
        <span class="st">&quot;by the total number of&quot;</span>,
        <span class="st">&quot;predictions&quot;</span>),
  <span class="st">&quot;gain_capture&quot;</span>, <span class="st">&quot;Gain Capture&quot;</span>, <span class="st">&quot;area under gain curve&quot;</span>,
  <span class="st">&quot;ppv&quot;</span>, <span class="st">&quot;Positive Predictive Value&quot;</span>,
  <span class="kw">paste</span>(<span class="st">&quot;percent of positive predictions&quot;</span>,
        <span class="st">&quot;that are  positive&quot;</span>),
  <span class="st">&quot;npv&quot;</span>, <span class="st">&quot;Negative Predictive Value&quot;</span>,
  <span class="kw">paste</span>(<span class="st">&quot;percent of negative predictions&quot;</span>,
        <span class="st">&quot;that are negative&quot;</span>),
  <span class="st">&quot;pr_auc&quot;</span>, <span class="st">&quot;Precision Recall AUC&quot;</span>, <span class="st">&quot;area under PR curve&quot;</span>,
  <span class="st">&quot;roc_auc&quot;</span>, <span class="st">&quot;ROC AUC&quot;</span>, <span class="st">&quot;area under ROC&quot;</span>)

<span class="co"># selection metric ----</span>
metric &lt;-<span class="st"> </span>metric.table <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> &quot;accuracy&quot;</span>)

<span class="co"># variable map to original names ----</span>
var.map &lt;-<span class="st"> </span><span class="kw">tribble</span>(
  <span class="op">~</span>raw, <span class="op">~</span>prepped, <span class="op">~</span>type, <span class="op">~</span>engineering,
  <span class="st">&quot;Title&quot;</span>, <span class="st">&quot;Role&quot;</span>, <span class="st">&quot;Categorical&quot;</span>, <span class="st">&quot;Aggregation&quot;</span>,
  <span class="st">&quot;Email&quot;</span>, <span class="st">&quot;PublicDomain&quot;</span>, <span class="st">&quot;Indicator&quot;</span>, <span class="st">&quot;Aggregation&quot;</span>,
  <span class="st">&quot;Email&quot;</span>, <span class="st">&quot;EmailSuffix&quot;</span>, <span class="st">&quot;Categorical&quot;</span>, <span class="st">&quot;Extraction&quot;</span>,
  <span class="st">&quot;LeadSource&quot;</span>, <span class="st">&quot;LeadSource&quot;</span>, <span class="st">&quot;Categorical&quot;</span>, <span class="st">&quot;Aggregation&quot;</span>,
  <span class="st">&quot;pi__created_date__c&quot;</span>, <span class="st">&quot;Age&quot;</span>, <span class="st">&quot;Numeric&quot;</span>, <span class="st">&quot;Conversion&quot;</span>,
  <span class="st">&quot;pi__last_activity__c&quot;</span>, <span class="st">&quot;LastActivity&quot;</span>, <span class="st">&quot;Numeric&quot;</span>, <span class="st">&quot;Conversion&quot;</span>,
  <span class="st">&quot;pi__first_activity__c&quot;</span>, <span class="st">&quot;ActivityDays&quot;</span>, <span class="st">&quot;Numeric&quot;</span>, <span class="st">&quot;Conversion&quot;</span>,
  <span class="st">&quot;Product_Service_Interest__c&quot;</span>, <span class="st">&quot;Interest&quot;</span>, <span class="st">&quot;Categorical&quot;</span>,
  <span class="st">&quot;Aggregation&quot;</span>,
  <span class="st">&quot;pi__score__c&quot;</span>, <span class="st">&quot;PardotScore&quot;</span>, <span class="st">&quot;Numeric&quot;</span>, <span class="st">&quot;None&quot;</span>,
  <span class="st">&quot;pi__first_touch_url__c&quot;</span>, <span class="st">&quot;KnownURL&quot;</span>, <span class="st">&quot;Indicator&quot;</span>, <span class="st">&quot;Aggregation&quot;</span>,
  <span class="st">&quot;pi__campaign__c&quot;</span>, <span class="st">&quot;Campaign&quot;</span>, <span class="st">&quot;Categorical&quot;</span>, <span class="st">&quot;Aggregation&quot;</span>,
  <span class="st">&quot;CreatedDate&quot;</span>, <span class="st">&quot;Quarter&quot;</span>, <span class="st">&quot;Numeric&quot;</span>, <span class="st">&quot;Conversion&quot;</span>
)</code></pre></div>
<div id="workflow" class="section level2">
<h2>Workflow</h2>
<p>The workflow proposed by<br />
<a href="http://www.feat.engineering/">Kuhn and Johnson (2019)</a> was implemented using <a href="https://github.com/tidymodels">tidymodel</a> tools.</p>
<p>Notably model development is completed inside a two-layer nested resampling scheme. This leads to a more robust model, enhanced confidence in development decisions and increased computation time.</p>
<p>To generate a single scoring run over 1,000 models will be fit to more than 100 distinct datasets.</p>
<p>Using resampling to create multiple distinct training sets prevents <strong>model overfitting</strong>. To further reduce the risk of <strong>overfitting predictors</strong> features are engineered during each resample. Any specious relationship between the predictors and outcome is unlikely to be propogated throughout the resamples. Measuring performance across a series of distinct resamples reduces the likelihood that <strong>performance estimates will be overly optimistic</strong>.</p>
<p>The performance measure used to select each model parameter was <strong>Accuracy</strong>, computed as percent of correct classifications. Bayesian model analysis, as outlined by <a href="http://people.idsia.ch/~marco/papers/2017jmlr-tests.pdf">Benavoli et al (2017)</a>, was used to validate each selection.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># modeling df -----</span>
<span class="co"># add NUM to original numeric variable names and</span>
<span class="co"># DM to categorical variable names</span>
<span class="co"># for easy recipe specification</span>
objs.model &lt;-<span class="st"> </span>objs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Id,
         CreatedDate,
         <span class="dt">AgeNUM =</span> Age,
         <span class="dt">ActivityDaysNUM =</span> ActivityDays,
         <span class="dt">LastActivityNUM =</span> LastActivity,
         <span class="dt">PardotScoreNUM =</span> PardotScore,
         <span class="dt">CampaignDM =</span> pi__campaign__c,
         <span class="dt">EmailSuffixDM =</span> EmailSuffix,
         <span class="dt">InterestDM =</span> Product_Service_Interest__c,
         <span class="dt">LeadSourceDM =</span> LeadSource,
         <span class="dt">TitleDM =</span> Title,
         PublicDomain,
         KnownURL,
         label) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(CreatedDate) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">QuarterNUM =</span> 
           <span class="kw">dense_rank</span>(<span class="kw">desc</span>(lubridate<span class="op">::</span><span class="kw">quarter</span>(CreatedDate,
                                              <span class="dt">with_year =</span> T))))

<span class="co"># training/testing records ----</span>
known.objs &lt;-<span class="st"> </span>objs.model <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(label)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>CreatedDate)

<span class="co"># initial split ----</span>
<span class="co"># create holdout set</span>
initial.split &lt;-<span class="st"> </span>rsample<span class="op">::</span><span class="kw">initial_split</span>(known.objs, 
                                        <span class="dt">prop =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>,
                                        <span class="dt">strata =</span> <span class="st">&quot;label&quot;</span>)

<span class="co"># cut training records</span>
training &lt;-<span class="st"> </span><span class="kw">training</span>(initial.split)

<span class="co"># resamples ----</span>
<span class="co"># external ----</span>
<span class="co"># create external folds</span>
<span class="co"># will only use 3 folds, but five gives 80/20 split</span>
folds.external &lt;-<span class="st"> </span>rsample<span class="op">::</span><span class="kw">vfold_cv</span>(training,
                                    <span class="dt">v =</span> <span class="dv">5</span>,
                                    <span class="dt">repeats =</span> <span class="dv">1</span>,
                                    <span class="dt">strata =</span> <span class="st">&quot;label&quot;</span>) 

<span class="co"># extract df of external folds</span>
analysis.external &lt;-<span class="st"> </span>folds.external<span class="op">$</span>splits <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">map</span>(., as.data.frame, <span class="dt">data =</span> <span class="st">&quot;analysis&quot;</span>)

<span class="co"># will add these to the internal fold test records by fold</span>
assess.external &lt;-<span class="st"> </span>folds.external<span class="op">$</span>splits <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">map</span>(., as.data.frame, <span class="dt">data =</span> <span class="st">&quot;assessment&quot;</span>)

<span class="co"># internal ----</span>
<span class="co"># create internal folds</span>
<span class="co"># to pick classifier</span>
folds.internal.mdl &lt;-<span class="st"> </span>rsample<span class="op">::</span><span class="kw">vfold_cv</span>(analysis.external[[<span class="dv">1</span>]],
                                        <span class="dt">v =</span> <span class="dv">5</span>,
                                        <span class="dt">repeats =</span> <span class="dv">10</span>,
                                        <span class="dt">strata =</span> <span class="st">&quot;label&quot;</span>) 

<span class="co"># to pick feature selection method</span>
folds.internal.vrs &lt;-<span class="st"> </span>rsample<span class="op">::</span><span class="kw">vfold_cv</span>(analysis.external[[<span class="dv">2</span>]],
                                        <span class="dt">v =</span> <span class="dv">5</span>,
                                        <span class="dt">repeats =</span> <span class="dv">10</span>,
                                        <span class="dt">strata =</span> <span class="st">&quot;label&quot;</span>) 

<span class="co"># to tune model hyperparameters  </span>
folds.internal.tn &lt;-<span class="st"> </span>rsample<span class="op">::</span><span class="kw">vfold_cv</span>(analysis.external[[<span class="dv">3</span>]],
                                        <span class="dt">v =</span> <span class="dv">5</span>,
                                        <span class="dt">repeats =</span> <span class="dv">1</span>,
                                        <span class="dt">strata =</span> <span class="st">&quot;label&quot;</span>) </code></pre></div>
</div>
<div id="nested-resamples" class="section level2">
<h2>Nested Resamples</h2>
<p>229 records were used for model development.<br />
24% of those were heldout from training to use for validation.</p>
<p><strong>External Resamples</strong> The 173 training records were resampled, creating 5 cross-validation folds, each containing 173 records.</p>
<p><strong>Internal Resamples</strong> Each external fold was repeatedly resampled, creating 10 sets of 5 cross-validation folds, each containing 137 records.</p>
<p>Each development decision was tested across all the internal resamples from a single external fold.</p>
<p>The selected parameters were used to fit the final model to all the training records and then validated with the holdout set.</p>
<p>A simplified diagram of the resampling scheme is below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># draw resampling diagram  </span>
DiagrammeR<span class="op">::</span><span class="kw">grViz</span>(<span class="st">&quot;digraph nested_resamples </span>
<span class="st">{</span>

<span class="st">  # a &#39;graph&#39; statement</span>
<span class="st">  graph [overlap = true, fontsize = 10]</span>

<span class="st">  # several &#39;node&#39; statements</span>
<span class="st">  node [shape = egg,</span>
<span class="st">        fontname = Helvetica,</span>
<span class="st">        label = &#39;Known Records&#39;]</span>
<span class="st">  Known </span>

<span class="st">  node [shape = circle,</span>
<span class="st">        color = DarkBlue,</span>
<span class="st">        fill = SeaShell,</span>
<span class="st">        label = &#39;Training Set&#39;]</span>
<span class="st">  Train </span>

<span class="st">  node [shape = oval,</span>
<span class="st">        fontcolor = DarkSlateGray,</span>
<span class="st">        fill = LightCyan,</span>
<span class="st">        label = &#39;Holdout Set&#39;]</span>
<span class="st">  Test </span>
<span class="st">  </span>
<span class="st">  node [shape = plaintext,</span>
<span class="st">        fontcolor = DarkBlue,</span>
<span class="st">        label = &#39;External Resample&#39;]</span>
<span class="st">  External1; ExternalA</span>

<span class="st">  node [shape = rectangle,</span>
<span class="st">        fontcolor = SteelBlue,</span>
<span class="st">        color = SteelBlue,</span>
<span class="st">        label = &#39;Classifier Selection&#39;]</span>
<span class="st">  Fold1</span>

<span class="st">  node [shape = rectangle,</span>
<span class="st">        fontcolor = SlateBlue,</span>
<span class="st">        color = SlateBlue,</span>
<span class="st">        label = &#39;Feature Selection&#39;]</span>
<span class="st">  FoldA </span>

<span class="st">  node [shape = plaintext,</span>
<span class="st">        fontcolor = SteelBlue,</span>
<span class="st">        color = SteelBlue,</span>
<span class="st">        label = &#39;Internal Resamples&#39;]</span>
<span class="st">  Internal1</span>

<span class="st">  node [shape = plaintext,</span>
<span class="st">        fontcolor = SlateBlue,</span>
<span class="st">        color = SlateBlue,</span>
<span class="st">        label = &#39;Internal Resamples&#39;]</span>
<span class="st">  InternalA </span>

<span class="st">  node [shape = circle,</span>
<span class="st">        fontcolor = SteelBlue,</span>
<span class="st">        color = SteelBlue,</span>
<span class="st">        fill = SeaShell,</span>
<span class="st">        label = &#39;Analysis&#39;]</span>
<span class="st">  train1; train2</span>
<span class="st">  </span>
<span class="st">  node [shape = circle,</span>
<span class="st">        fontcolor = SlateBlue,</span>
<span class="st">        color = SlateBlue,</span>
<span class="st">        fill = SeaShell,</span>
<span class="st">        label = &#39;Analysis&#39;]</span>
<span class="st">  trainA; trainB</span>

<span class="st">  node [shape = oval,</span>
<span class="st">        fontcolor = DarkSlateGray,</span>
<span class="st">        color = SteelBlue,</span>
<span class="st">        fill = LightCyan,</span>
<span class="st">        label = &#39;Assessment&#39;]</span>
<span class="st">  test1; test2</span>

<span class="st">  node [shape = oval,</span>
<span class="st">        fontcolor = DarkSlateGray,</span>
<span class="st">        color = SlateBlue,</span>
<span class="st">        fill = LightCyan,</span>
<span class="st">        label = &#39;Assessment&#39;]</span>
<span class="st">  testA; testB</span>

<span class="st">  subgraph {</span>
<span class="st">    rank = same; Test; Train;</span>
<span class="st">  }</span>

<span class="st">  subgraph {</span>
<span class="st">    rank = same; External1; ExternalA;</span>
<span class="st">  }</span>

<span class="st">  subgraph {</span>
<span class="st">    rank = same; Fold1; FoldA;</span>
<span class="st">  }</span>

<span class="st">  subgraph {</span>
<span class="st">    rank = same; Internal1; InternalA;</span>
<span class="st">  }</span>
<span class="st">  </span>
<span class="st">  subgraph {</span>
<span class="st">    rank = same; train1; test1; train2; test2; </span>
<span class="st">                 trainA; testA, trainB; testB;</span>
<span class="st">  }</span>

<span class="st">  # several &#39;edge&#39; statements</span>
<span class="st">  Known-&gt;Test [arrowhead = none]</span>
<span class="st">  Known-&gt;Train</span>
<span class="st">  Train-&gt;Test[arrowhead = diamond]</span>
<span class="st">  Train-&gt;{External1 ExternalA}[arrowhead = none]</span>
<span class="st">  External1-&gt;Fold1</span>
<span class="st">  ExternalA-&gt;FoldA</span>
<span class="st">  Fold1-&gt;Internal1 [color = SteelBlue, arrowhead = none]</span>
<span class="st">  Internal1-&gt;{train1 train2} [color = SteelBlue]</span>
<span class="st">  Internal1-&gt;{test1 test2}[color = SteelBlue,arrowhead = none]</span>
<span class="st">  FoldA-&gt;InternalA [color = SlateBlue, arrowhead = none]</span>
<span class="st">  InternalA-&gt;{trainA trainB} [color = SlateBlue]</span>
<span class="st">  InternalA-&gt;{testA testB}[color = SlateBlue,arrowhead = none]</span>
<span class="st">  train1-&gt;test1 [color = SteelBlue, arrowhead = diamond]</span>
<span class="st">  train2-&gt;test2 [color = SteelBlue, arrowhead = diamond]</span>
<span class="st">  trainA-&gt;testA [color = SlateBlue, arrowhead = diamond]</span>
<span class="st">  trainB-&gt;testB [color = SlateBlue, arrowhead = diamond]</span>
<span class="st">}</span>
<span class="st">&quot;</span>)</code></pre></div>
<div id="htmlwidget-f289757ec4680b9821e8" style="width:576px;height:384px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-f289757ec4680b9821e8">{"x":{"diagram":"digraph nested_resamples \n{\n\n  # a \"graph\" statement\n  graph [overlap = true, fontsize = 10]\n\n  # several \"node\" statements\n  node [shape = egg,\n        fontname = Helvetica,\n        label = \"Known Records\"]\n  Known \n\n  node [shape = circle,\n        color = DarkBlue,\n        fill = SeaShell,\n        label = \"Training Set\"]\n  Train \n\n  node [shape = oval,\n        fontcolor = DarkSlateGray,\n        fill = LightCyan,\n        label = \"Holdout Set\"]\n  Test \n  \n  node [shape = plaintext,\n        fontcolor = DarkBlue,\n        label = \"External Resample\"]\n  External1; ExternalA\n\n  node [shape = rectangle,\n        fontcolor = SteelBlue,\n        color = SteelBlue,\n        label = \"Classifier Selection\"]\n  Fold1\n\n  node [shape = rectangle,\n        fontcolor = SlateBlue,\n        color = SlateBlue,\n        label = \"Feature Selection\"]\n  FoldA \n\n  node [shape = plaintext,\n        fontcolor = SteelBlue,\n        color = SteelBlue,\n        label = \"Internal Resamples\"]\n  Internal1\n\n  node [shape = plaintext,\n        fontcolor = SlateBlue,\n        color = SlateBlue,\n        label = \"Internal Resamples\"]\n  InternalA \n\n  node [shape = circle,\n        fontcolor = SteelBlue,\n        color = SteelBlue,\n        fill = SeaShell,\n        label = \"Analysis\"]\n  train1; train2\n  \n  node [shape = circle,\n        fontcolor = SlateBlue,\n        color = SlateBlue,\n        fill = SeaShell,\n        label = \"Analysis\"]\n  trainA; trainB\n\n  node [shape = oval,\n        fontcolor = DarkSlateGray,\n        color = SteelBlue,\n        fill = LightCyan,\n        label = \"Assessment\"]\n  test1; test2\n\n  node [shape = oval,\n        fontcolor = DarkSlateGray,\n        color = SlateBlue,\n        fill = LightCyan,\n        label = \"Assessment\"]\n  testA; testB\n\n  subgraph {\n    rank = same; Test; Train;\n  }\n\n  subgraph {\n    rank = same; External1; ExternalA;\n  }\n\n  subgraph {\n    rank = same; Fold1; FoldA;\n  }\n\n  subgraph {\n    rank = same; Internal1; InternalA;\n  }\n  \n  subgraph {\n    rank = same; train1; test1; train2; test2; \n                 trainA; testA, trainB; testB;\n  }\n\n  # several \"edge\" statements\n  Known->Test [arrowhead = none]\n  Known->Train\n  Train->Test[arrowhead = diamond]\n  Train->{External1 ExternalA}[arrowhead = none]\n  External1->Fold1\n  ExternalA->FoldA\n  Fold1->Internal1 [color = SteelBlue, arrowhead = none]\n  Internal1->{train1 train2} [color = SteelBlue]\n  Internal1->{test1 test2}[color = SteelBlue,arrowhead = none]\n  FoldA->InternalA [color = SlateBlue, arrowhead = none]\n  InternalA->{trainA trainB} [color = SlateBlue]\n  InternalA->{testA testB}[color = SlateBlue,arrowhead = none]\n  train1->test1 [color = SteelBlue, arrowhead = diamond]\n  train2->test2 [color = SteelBlue, arrowhead = diamond]\n  trainA->testA [color = SlateBlue, arrowhead = diamond]\n  trainB->testB [color = SlateBlue, arrowhead = diamond]\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="model-parameters" class="section level1 tabset tabset-pills">
<h1>Model Parameters</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># html format</span>
model.kable &lt;-<span class="st"> </span>knitr<span class="op">::</span><span class="kw">kable</span>(model.labels <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                              </span><span class="kw">select</span>(<span class="dt">Model =</span> long,
                                     <span class="dt">Type =</span> type),
                            <span class="dt">format =</span> <span class="st">&quot;html&quot;</span>,
                            <span class="dt">align =</span> <span class="st">&quot;c&quot;</span>)

<span class="co"># html format</span>
feature.kable &lt;-<span class="st"> </span>knitr<span class="op">::</span><span class="kw">kable</span>(feature.selectors,
                            <span class="dt">format =</span> <span class="st">&quot;html&quot;</span>,
                            <span class="dt">align =</span> <span class="st">&quot;c&quot;</span>)

<span class="co"># recipes ----------</span>
<span class="co"># recipe for all variables</span>
<span class="co"># use NUM identify actual numeric variables</span>
<span class="co"># create polynomials, interactions &amp; dummy variables</span>
rec.all &lt;-<span class="st"> </span><span class="kw">recipe</span>(label <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> training) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">update_role</span>(Id, <span class="dt">new_role =</span> <span class="st">&quot;id.var&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_mutate</span>(<span class="dt">TitleDM =</span> <span class="kw">token_freq</span>(TitleDM)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_mutate</span>(<span class="dt">InterestDM =</span> <span class="kw">token_freq</span>(InterestDM)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_mutate</span>(<span class="dt">LeadSourceDM =</span> <span class="kw">token_freq</span>(LeadSourceDM)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_mutate</span>(<span class="dt">CampaignDM =</span> <span class="kw">token_freq</span>(CampaignDM)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_modeimpute</span>(<span class="kw">all_nominal</span>(), 
                  <span class="op">-</span><span class="kw">all_outcomes</span>(),
                  <span class="op">-</span>Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_other</span>(<span class="kw">all_nominal</span>(),
             <span class="dt">threshold =</span> <span class="fl">0.05</span>,
             <span class="dt">other =</span> <span class="st">&quot;Other&quot;</span>,
             <span class="op">-</span><span class="kw">all_outcomes</span>(), 
             <span class="op">-</span>Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_knnimpute</span>(<span class="kw">all_numeric</span>(), 
                 <span class="dt">neighbors =</span> <span class="dv">3</span>, 
                 <span class="op">-</span><span class="kw">all_outcomes</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_dummy</span>(<span class="kw">all_nominal</span>(), 
             <span class="op">-</span><span class="kw">all_outcomes</span>(), <span class="op">-</span>Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_interact</span>(<span class="dt">terms =</span> <span class="op">~</span><span class="st"> </span>
<span class="st">                  </span><span class="kw">contains</span>(<span class="st">&quot;NUM&quot;</span>)<span class="op">:</span><span class="kw">contains</span>(<span class="st">&quot;DM&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_poly</span>(<span class="kw">ends_with</span>(<span class="st">&quot;NUM&quot;</span>),
            <span class="dt">options =</span> <span class="kw">list</span>(<span class="dt">degree =</span> <span class="dv">4</span>),
            <span class="op">-</span><span class="kw">all_outcomes</span>(),
            <span class="op">-</span>Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_lincomb</span>(<span class="kw">all_predictors</span>(),
               <span class="op">-</span><span class="kw">all_outcomes</span>(), <span class="op">-</span>Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_zv</span>(<span class="kw">all_predictors</span>(),
          <span class="op">-</span><span class="kw">all_outcomes</span>(), <span class="op">-</span>Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_nzv</span>(<span class="kw">all_predictors</span>(),
           <span class="op">-</span><span class="kw">all_outcomes</span>(), <span class="op">-</span>Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_corr</span>(<span class="kw">all_predictors</span>(), 
            <span class="dt">threshold =</span> <span class="fl">0.7</span>,
            <span class="dt">method =</span> <span class="st">&quot;pearson&quot;</span>,
            <span class="op">-</span><span class="kw">all_outcomes</span>(), <span class="op">-</span>Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_center</span>(<span class="kw">all_predictors</span>(),
              <span class="op">-</span><span class="kw">all_outcomes</span>(), <span class="op">-</span>Id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">step_scale</span>(<span class="kw">all_predictors</span>(),
             <span class="op">-</span><span class="kw">all_outcomes</span>(), <span class="op">-</span>Id) 

<span class="co"># parsnip model setup ------------</span>
<span class="co"># specs for each classifier to consider</span>

<span class="co"># log reg specification</span>
prs.log &lt;-<span class="st"> </span><span class="kw">logistic_reg</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;glm&quot;</span>, 
             <span class="dt">family =</span> stats<span class="op">::</span>binomial)

<span class="co"># rf specification</span>
prs.rf &lt;-<span class="st"> </span><span class="kw">rand_forest</span>(<span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span>,
                      <span class="dt">mtry =</span> <span class="kw">.preds</span>(),
                      <span class="dt">trees =</span> <span class="dv">2000</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;ranger&quot;</span>,
             <span class="dt">importance =</span> <span class="st">&quot;impurity&quot;</span>,
             <span class="dt">probability =</span> <span class="ot">TRUE</span>)

<span class="co"># svm specification</span>
prs.svm &lt;-<span class="st"> </span><span class="kw">svm_rbf</span>(<span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;kernlab&quot;</span>,
             <span class="dt">kernel =</span> <span class="st">&quot;rbfdot&quot;</span>,
             <span class="dt">prob.model =</span> T)

<span class="co"># xgb specification</span>
prs.xgb &lt;-<span class="st"> </span><span class="kw">boost_tree</span>(<span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>,
             <span class="dt">prob.model =</span> T)

<span class="co"># list of parsnip model specs</span>
models &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;GLM&quot;</span> =<span class="st"> </span>prs.log,
               <span class="st">&quot;RF&quot;</span> =<span class="st"> </span>prs.rf,
               <span class="st">&quot;SVM&quot;</span> =<span class="st"> </span>prs.svm,
               <span class="st">&quot;XGB&quot;</span> =<span class="st"> </span>prs.xgb)</code></pre></div>
<div id="features" class="section level2 tabset">
<h2>Features</h2>
<p>The primary input was 11 variables extracted from Salesforce.</p>
<p>Prior to model development, numeric values were generated from the date variables and indicator variables created.</p>
<div id="variables" class="section level3">
<h3>Variables</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># combine var counts</span>
var.tbl &lt;-<span class="st"> </span>var.map <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="st">`</span><span class="dt">Source Variable</span><span class="st">`</span> =<span class="st"> </span>raw,
         <span class="st">`</span><span class="dt">Modeling Variable</span><span class="st">`</span> =<span class="st"> </span>prepped,
         <span class="dt">Type =</span> type,
         <span class="dt">Engineering =</span> engineering) 

<span class="co"># html format table</span>
var.kbl &lt;-<span class="st"> </span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(var.tbl <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                 </span><span class="kw">select</span>(<span class="st">`</span><span class="dt">Source Variable</span><span class="st">`</span>,
                        <span class="st">`</span><span class="dt">Modeling Variable</span><span class="st">`</span>,
                        Type,
                        Engineering) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                 </span><span class="kw">arrange</span>(<span class="st">`</span><span class="dt">Source Variable</span><span class="st">`</span>),
               <span class="st">&quot;html&quot;</span>,
               <span class="dt">align =</span> <span class="st">&quot;c&quot;</span>)

kableExtra<span class="op">::</span><span class="kw">kable_styling</span>(var.kbl,
                          <span class="dt">bootstrap_options =</span> <span class="kw">c</span>(<span class="st">&quot;bordered&quot;</span>,
                                                <span class="st">&quot;striped&quot;</span>))</code></pre></div>
<table class="table table-bordered table-striped" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:center;">
Source Variable
</th>
<th style="text-align:center;">
Modeling Variable
</th>
<th style="text-align:center;">
Type
</th>
<th style="text-align:center;">
Engineering
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
CreatedDate
</td>
<td style="text-align:center;">
Quarter
</td>
<td style="text-align:center;">
Numeric
</td>
<td style="text-align:center;">
Conversion
</td>
</tr>
<tr>
<td style="text-align:center;">
Email
</td>
<td style="text-align:center;">
PublicDomain
</td>
<td style="text-align:center;">
Indicator
</td>
<td style="text-align:center;">
Aggregation
</td>
</tr>
<tr>
<td style="text-align:center;">
Email
</td>
<td style="text-align:center;">
EmailSuffix
</td>
<td style="text-align:center;">
Categorical
</td>
<td style="text-align:center;">
Extraction
</td>
</tr>
<tr>
<td style="text-align:center;">
LeadSource
</td>
<td style="text-align:center;">
LeadSource
</td>
<td style="text-align:center;">
Categorical
</td>
<td style="text-align:center;">
Aggregation
</td>
</tr>
<tr>
<td style="text-align:center;">
pi__campaign__c
</td>
<td style="text-align:center;">
Campaign
</td>
<td style="text-align:center;">
Categorical
</td>
<td style="text-align:center;">
Aggregation
</td>
</tr>
<tr>
<td style="text-align:center;">
pi__created_date__c
</td>
<td style="text-align:center;">
Age
</td>
<td style="text-align:center;">
Numeric
</td>
<td style="text-align:center;">
Conversion
</td>
</tr>
<tr>
<td style="text-align:center;">
pi__first_activity__c
</td>
<td style="text-align:center;">
ActivityDays
</td>
<td style="text-align:center;">
Numeric
</td>
<td style="text-align:center;">
Conversion
</td>
</tr>
<tr>
<td style="text-align:center;">
pi__first_touch_url__c
</td>
<td style="text-align:center;">
KnownURL
</td>
<td style="text-align:center;">
Indicator
</td>
<td style="text-align:center;">
Aggregation
</td>
</tr>
<tr>
<td style="text-align:center;">
pi__last_activity__c
</td>
<td style="text-align:center;">
LastActivity
</td>
<td style="text-align:center;">
Numeric
</td>
<td style="text-align:center;">
Conversion
</td>
</tr>
<tr>
<td style="text-align:center;">
pi__score__c
</td>
<td style="text-align:center;">
PardotScore
</td>
<td style="text-align:center;">
Numeric
</td>
<td style="text-align:center;">
None
</td>
</tr>
<tr>
<td style="text-align:center;">
Product_Service_Interest__c
</td>
<td style="text-align:center;">
Interest
</td>
<td style="text-align:center;">
Categorical
</td>
<td style="text-align:center;">
Aggregation
</td>
</tr>
<tr>
<td style="text-align:center;">
Title
</td>
<td style="text-align:center;">
Role
</td>
<td style="text-align:center;">
Categorical
</td>
<td style="text-align:center;">
Aggregation
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="design-matrix" class="section level2">
<h2>Design Matrix</h2>
<p>The following steps were applied individually to each internal resample:</p>
<ol style="list-style-type: decimal">
<li>The most frequent value was used to impute missing categorical variables<br />
</li>
<li>Rare categorical responses were grouped into an ‘other’ category<br />
</li>
<li>Categorical variables were contrast coded into numeric predictors<br />
</li>
<li>Nearest neighbor was used to impute missing numeric variables<br />
</li>
<li>Two-way interactions were created between dummy categorical predictors and numeric predictors<br />
</li>
<li>Fourth degree polynomial predictors were created from the numeric variables<br />
</li>
<li>Filters were applied to remove predictors:
<ul>
<li>with no variance<br />
</li>
<li>with sparse or unbalanced responses<br />
</li>
<li>that were highly correlated<br />
</li>
<li>with multicollinearity<br />
</li>
</ul></li>
<li>Predictors were centered and scaled</li>
</ol>
</div>
<div id="classifier" class="section level2">
<h2>Classifier</h2>
<p>The 4 classifiers under consideration were fit to 50 datasets created from the first external fold.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">kableExtra<span class="op">::</span><span class="kw">kable_styling</span>(model.kable,
                          <span class="dt">bootstrap_options =</span> 
                            <span class="kw">c</span>(<span class="st">&quot;bordered&quot;</span>, <span class="st">&quot;striped&quot;</span>))</code></pre></div>
<table class="table table-bordered table-striped" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:center;">
Model
</th>
<th style="text-align:center;">
Type
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
Logistic Regression
</td>
<td style="text-align:center;">
General linear model
</td>
</tr>
<tr>
<td style="text-align:center;">
Random Forest
</td>
<td style="text-align:center;">
Bagged ensemble of decision trees
</td>
</tr>
<tr>
<td style="text-align:center;">
Support Vector Machine
</td>
<td style="text-align:center;">
Kernelized linear approximation
</td>
</tr>
<tr>
<td style="text-align:center;">
Xtreme Gradient Boosting
</td>
<td style="text-align:center;">
Boosted ensemble of decision trees
</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># resample analysis ----</span>
<span class="co"># add columns with analysis and assessment data to rsample split</span>
<span class="co"># apply recipe to analysis set of each fold individually</span>
<span class="co"># prep analysis and assessment sets</span>
<span class="co"># add formula for each fold</span>
folds.internal &lt;-<span class="st"> </span>folds.internal.mdl <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">analysis =</span> <span class="kw">map</span>(splits, as.data.frame, <span class="dt">data =</span> <span class="st">&quot;analysis&quot;</span>),
         <span class="dt">assessment =</span>  <span class="kw">map</span>(splits, as.data.frame, 
                           <span class="dt">data =</span> <span class="st">&quot;assessment&quot;</span>),
         <span class="dt">assessment =</span> <span class="kw">map</span>(assessment, bind_rows,
                          assess.external[[<span class="dv">1</span>]]),
         <span class="dt">prep =</span> <span class="kw">map</span>(analysis, df_prep, <span class="dt">rec =</span> rec.all),
         <span class="dt">analysis =</span> <span class="kw">map2</span>(prep, analysis, bake),
         <span class="dt">assessment =</span> <span class="kw">map2</span>(prep, assessment, bake),
         <span class="dt">form =</span> <span class="kw">map</span>(prep, formula)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>splits) 

<span class="co"># fit each model to analysis set of each fold individually</span>
<span class="co"># generate predictions for assessment set</span>
folds.internal &lt;-<span class="st"> </span>folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">RF =</span> <span class="kw">map2</span>(analysis, form, prs_form, 
                   <span class="dt">prs =</span> models[[<span class="st">&quot;RF&quot;</span>]]),
         <span class="dt">RF =</span> <span class="kw">map2</span>(RF, assessment, predict, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>),
         <span class="dt">SVM =</span> <span class="kw">map2</span>(analysis, form, prs_form, 
                    <span class="dt">prs =</span> models[[<span class="st">&quot;SVM&quot;</span>]]),
         <span class="dt">SVM =</span> <span class="kw">map2</span>(SVM, assessment, predict, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>),
         <span class="dt">XGB =</span> <span class="kw">map2</span>(analysis, form, prs_form, 
                    <span class="dt">prs =</span> models[[<span class="st">&quot;XGB&quot;</span>]]),
         <span class="dt">XGB =</span> <span class="kw">map2</span>(XGB, assessment, predict, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>),
         <span class="dt">GLM =</span> <span class="kw">map2</span>(analysis, form, prs_form, 
                       <span class="dt">prs =</span> models[[<span class="st">&quot;GLM&quot;</span>]]),
         <span class="dt">GLM =</span> <span class="kw">map2</span>(GLM, assessment, predict, 
                            <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">truth =</span> <span class="kw">map</span>(assessment, <span class="op">~</span><span class="kw">select</span>(., Id, label))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(id, id2, truth, RF, SVM, XGB, GLM) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(model, preds, <span class="op">-</span><span class="kw">c</span>(id, id2, truth))

<span class="co"># to unnest list columns, df list-elements need equal rows</span>
<span class="co"># get row count by list element</span>
pads &lt;-<span class="st"> </span><span class="kw">map_dbl</span>(folds.internal<span class="op">$</span>assessment, nrow)

<span class="co"># max row count</span>
pad.max &lt;-<span class="st"> </span><span class="kw">max</span>(pads)

<span class="co"># list of df to pad truth column</span>
pads.id &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">nrow</span>(folds.internal))
<span class="cf">for</span>(i <span class="cf">in</span>(<span class="kw">seq_along</span>(pads))){
  pads.id[[i]] &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;Id&quot;</span> =<span class="st"> </span>
<span class="st">                                   </span><span class="kw">rep</span>(<span class="st">&quot;0&quot;</span>, pad.max <span class="op">-</span><span class="st"> </span>pads[[i]])))
  pads.id
}

<span class="co"># list of df to pad prediction columns</span>
pads.pd &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">nrow</span>(folds.internal))
<span class="cf">for</span>(i <span class="cf">in</span>(<span class="kw">seq_along</span>(pads))){
  pads.pd[[i]] &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;.pred_Yes&quot;</span> =<span class="st"> </span>
<span class="st">                                   </span><span class="kw">rep</span>(<span class="dv">0</span>, pad.max <span class="op">-</span><span class="st"> </span>pads[[i]])))
  pads.pd
}

<span class="co"># evenup rows</span>
<span class="co"># gather and unnest</span>
<span class="co"># add naive class</span>
<span class="co"># drop padding</span>
<span class="co"># drop models that fail to predict both outcomes</span>
folds.pred &lt;-<span class="st"> </span>folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">   </span><span class="kw">mutate</span>(<span class="dt">truth =</span> <span class="kw">map2</span>(truth, pads.id, bind_rows),
          <span class="dt">preds =</span> <span class="kw">map2</span>(preds, pads.pd, bind_rows)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">.pred_class =</span> <span class="kw">ifelse</span>(.pred_Yes <span class="op">&gt;</span><span class="st"> </span>.pred_No, <span class="st">&quot;Yes&quot;</span>,
                              <span class="st">&quot;No&quot;</span>),
         <span class="dt">.pred_class =</span> <span class="kw">factor</span>(.pred_class, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;Yes&quot;</span>,
                                                      <span class="st">&quot;No&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(Id <span class="op">!=</span><span class="st"> &quot;0&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(.pred_class)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(id, id2, model) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">classes =</span> <span class="kw">n_distinct</span>(.pred_class)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(classes <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(model) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">folds =</span> <span class="kw">max</span>(<span class="kw">row_number</span>())) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(id, id2, model) 

<span class="co"># count labels per fold</span>
fold.rate &lt;-<span class="st"> </span>folds.pred <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(id, id2, model, label) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Rate =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(label <span class="op">==</span><span class="st"> &quot;Yes&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(id, id2, model, Rate)

<span class="co"># compute summary metrics</span>
classifier.summary &lt;-<span class="st"> </span>folds.pred <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">conf_mat</span>(<span class="dt">truth =</span> label, .pred_class) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">summary =</span> <span class="kw">map</span>(conf_mat, summary)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(id, id2, model, summary) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(folds.pred <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">mn_log_loss</span>(<span class="dt">truth =</span> label, .pred_Yes) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">mutate</span>(<span class="dt">.estimate =</span> <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.estimate))

<span class="co"># rank based on selected metric</span>
class.rank &lt;-<span class="st"> </span>classifier.summary <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> </span>metric<span class="op">$</span>.metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(model, .metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">.estimate =</span> <span class="kw">mean</span>(.estimate)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(.metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rank =</span> <span class="kw">dense_rank</span>(<span class="kw">desc</span>(.estimate))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(rank)

<span class="co"># prepare for bayes ttest</span>
<span class="co"># on performance measure of interest</span>
class.test &lt;-<span class="st"> </span>classifier.summary <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> </span>metric<span class="op">$</span>.metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(id, id2, model, .metric, .estimate) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">spread</span>(model, .estimate, <span class="dt">fill =</span> <span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(.metric, id, id2)

<span class="co"># bayes ttest</span>
class.ab &lt;-<span class="st"> </span><span class="kw">bayes_ttest</span>(class.rank, <span class="st">&quot;model&quot;</span>, class.test, 
                        <span class="dt">.flds =</span> <span class="kw">length</span>(<span class="kw">unique</span>(class.test<span class="op">$</span>id))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">map</span>(., <span class="op">~</span><span class="kw">gather</span>(., key, prob)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(<span class="dt">.id =</span> <span class="st">&quot;pair&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">equal.better =</span> <span class="kw">str_detect</span>(key, <span class="st">&quot;=|&gt;&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(pair, equal.better) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">combined =</span> <span class="kw">sum</span>(prob)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">separate</span>(key, <span class="kw">c</span>(<span class="st">&quot;b&quot;</span>, <span class="st">&quot;w&quot;</span>),
           <span class="dt">sep =</span> <span class="st">&quot; &gt; | = | &lt;&quot;</span>, <span class="dt">remove =</span> F) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">b =</span> <span class="kw">str_trim</span>(b, <span class="st">&quot;both&quot;</span>),
         <span class="dt">w =</span> <span class="kw">str_trim</span>(w, <span class="st">&quot;both&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(model.labels <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">select</span>(<span class="dt">b =</span> model,
                     <span class="dt">better =</span> long)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(model.labels <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">select</span>(<span class="dt">w =</span> model,
                     <span class="dt">than =</span> long))

<span class="co"># selected classifier -----</span>
classifier &lt;-<span class="st"> </span>class.rank[class.rank<span class="op">$</span>rank <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, ]<span class="op">$</span>model

<span class="co"># plot titles</span>
class.title &lt;-<span class="st"> </span><span class="kw">paste0</span>(model.labels[model.labels<span class="op">$</span>model <span class="op">==</span>
<span class="st">                                     </span>classifier,]<span class="op">$</span>long,
                      <span class="st">&quot; averaged &quot;</span>,
                      <span class="kw">round</span>(class.rank[class.rank<span class="op">$</span>rank <span class="op">==</span><span class="st"> </span><span class="dv">1</span>,
                                       ]<span class="op">$</span>.estimate, <span class="dv">3</span>) <span class="op">*</span><span class="dv">100</span>,
                      <span class="st">&quot;% &quot;</span>,
                      <span class="kw">str_to_lower</span>(metric<span class="op">$</span>metric))
                      
class.subtitle &lt;-<span class="st"> </span><span class="kw">prose_title</span>(class.ab, <span class="dt">.type =</span> <span class="st">&quot;classifier&quot;</span>)

<span class="co"># model specs</span>
classifier.spec &lt;-<span class="st"> </span>models[[classifier]]


<span class="kw">plot_folds</span>(classifier.summary, 
           class.title,
           class.subtitle)</code></pre></div>
<p><img src="demo_files/figure-html/classifierSelect-1.png" width="576" /></p>
</div>
<div id="feature-selection" class="section level2">
<h2>Feature Selection</h2>
<p>A Xtreme Gradient Boosting model was fit to 6 different subsets of features selected from each of the 50 datasets resampled from the second external fold.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">kableExtra<span class="op">::</span><span class="kw">kable_styling</span>(feature.kable,
                          <span class="dt">bootstrap_options =</span>
                            <span class="kw">c</span>(<span class="st">&quot;bordered&quot;</span>, <span class="st">&quot;striped&quot;</span>))</code></pre></div>
<table class="table table-bordered table-striped" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:center;">
Name
</th>
<th style="text-align:center;">
Details
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
All
</td>
<td style="text-align:center;">
Filters for correlation, colinearity and variance
</td>
</tr>
<tr>
<td style="text-align:center;">
Importance
</td>
<td style="text-align:center;">
Absolute value of coefficents from fitted glmnet model
</td>
</tr>
<tr>
<td style="text-align:center;">
Relevance
</td>
<td style="text-align:center;">
Importance versus importance achievable at random
</td>
</tr>
<tr>
<td style="text-align:center;">
Significance
</td>
<td style="text-align:center;">
Significant improvement over intercept only model
</td>
</tr>
<tr>
<td style="text-align:center;">
Exclusive
</td>
<td style="text-align:center;">
Variables in Importance &amp; Relevance &amp; Significance selections
</td>
</tr>
<tr>
<td style="text-align:center;">
Inclusive
</td>
<td style="text-align:center;">
Variables in Importance or Relevance or Significance selections
</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># this chunk takes a while</span>
<span class="co"># split folds</span>
<span class="co"># prep recipe on analysis set for each fold</span>
folds.internal &lt;-<span class="st"> </span>folds.internal.vrs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">analysis =</span> <span class="kw">map</span>(splits,
                        as.data.frame, <span class="dt">data =</span> <span class="st">&quot;analysis&quot;</span>),
         <span class="dt">assessment =</span> <span class="kw">map</span>(splits, as.data.frame, 
               <span class="dt">data =</span> <span class="st">&quot;assessment&quot;</span>),
         <span class="dt">assessment =</span> <span class="kw">map</span>(assessment, bind_rows,
                          assess.external[[<span class="dv">2</span>]]),
         <span class="dt">prep =</span> <span class="kw">map</span>(analysis, df_prep, <span class="dt">rec =</span> rec.all)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>splits)

<span class="co"># bake analysis and assessment sets</span>
<span class="co"># run feature selection methods</span>
<span class="co"># make long</span>
folds.internal &lt;-<span class="st"> </span>folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">analysis =</span> <span class="kw">map2</span>(prep, analysis, bake),
         <span class="dt">assessment =</span> <span class="kw">map2</span>(prep, assessment, bake),
         <span class="dt">All =</span> <span class="kw">map</span>(analysis, colnames),
         <span class="dt">All =</span> <span class="kw">map</span>(All, setdiff, <span class="kw">c</span>(<span class="st">&quot;Id&quot;</span>, <span class="st">&quot;label&quot;</span>)),
         <span class="dt">Importance =</span> <span class="kw">map2</span>(analysis, <span class="kw">map</span>(prep, formula), var_imp),
         <span class="dt">Relevance =</span> <span class="kw">map2</span>(analysis, <span class="kw">map</span>(prep, formula), var_rel),
         <span class="dt">Significance =</span> <span class="kw">map2</span>(analysis, All, var_sig),
         <span class="dt">Exclusive =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(Importance, Relevance, Significance),
                          triple_inter),
         <span class="dt">Inclusive =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(Importance, Relevance, Significance),
                          triple_u)) <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>prep) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(fs, forms, <span class="op">-</span><span class="kw">c</span>(id, id2, analysis, assessment))

<span class="co"># fit models and predict assessment sets</span>
folds.internal &lt;-<span class="st"> </span>folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">vrs =</span> <span class="kw">map</span>(forms, length)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(vrs <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">forms =</span> <span class="kw">map</span>(forms, as_formula),
           <span class="dt">fits =</span> <span class="kw">map2</span>(analysis, forms, prs_form,
                            <span class="dt">prs =</span> classifier.spec),
           <span class="dt">preds =</span> <span class="kw">map2</span>(fits,  assessment, predict,
                           <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>))

<span class="co"># average vars selected by each fs</span>
folds.vrs &lt;-<span class="st"> </span>folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(fs, vrs) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(fs) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">vrs =</span> <span class="kw">round</span>(<span class="kw">mean</span>(vrs)))

<span class="co"># to unnest list columns, df list-elements need equal rows</span>
<span class="co"># get row count by list element</span>
pads &lt;-<span class="st"> </span><span class="kw">map_dbl</span>(folds.internal<span class="op">$</span>assessment, nrow)

<span class="co"># max row count</span>
pad.max &lt;-<span class="st"> </span><span class="kw">max</span>(pads)

<span class="co"># list of df to pad truth column</span>
pads.id &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">nrow</span>(folds.internal))
<span class="cf">for</span>(i <span class="cf">in</span>(<span class="kw">seq_along</span>(pads))){
  pads.id[[i]] &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;Id&quot;</span> =<span class="st"> </span>
<span class="st">                                   </span><span class="kw">rep</span>(<span class="st">&quot;0&quot;</span>, pad.max <span class="op">-</span><span class="st"> </span>pads[[i]])))
  pads.id
}

<span class="co"># list of df to pad prediction columns</span>
pads.pd &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">nrow</span>(folds.internal))
<span class="cf">for</span>(i <span class="cf">in</span>(<span class="kw">seq_along</span>(pads))){
  pads.pd[[i]] &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;.pred_Yes&quot;</span> =<span class="st"> </span>
<span class="st">                                   </span><span class="kw">rep</span>(<span class="dv">0</span>, pad.max <span class="op">-</span><span class="st"> </span>pads[[i]])))
  pads.pd
}

<span class="co"># evenup rows</span>
<span class="co"># add naive class</span>
<span class="co"># drop padding</span>
folds.pred &lt;-<span class="st"> </span>folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">truth =</span> <span class="kw">map</span>(assessment, <span class="op">~</span><span class="kw">select</span>(., Id, label))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(id, id2, fs, truth, preds) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">truth =</span> <span class="kw">map2</span>(truth, pads.id, bind_rows),
         <span class="dt">preds =</span> <span class="kw">map2</span>(preds, pads.pd, bind_rows)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">.pred_class =</span> <span class="kw">ifelse</span>(.pred_Yes <span class="op">&gt;</span><span class="st"> </span>.pred_No, <span class="st">&quot;Yes&quot;</span>,
                              <span class="st">&quot;No&quot;</span>),
         <span class="dt">.pred_class =</span> <span class="kw">factor</span>(.pred_class, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;Yes&quot;</span>,
                                                      <span class="st">&quot;No&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(Id <span class="op">!=</span><span class="st"> &quot;0&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(.pred_class)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(id, id2, fs) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">classes =</span> <span class="kw">n_distinct</span>(.pred_class)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(classes <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(fs) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">folds =</span> <span class="kw">max</span>(<span class="kw">row_number</span>())) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(folds <span class="op">&gt;</span><span class="st"> </span>(<span class="kw">max</span>(folds) <span class="op">*</span><span class="st"> </span><span class="fl">0.7</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(id, id2, fs) 

<span class="co"># summary metrics</span>
fs.summary &lt;-<span class="st"> </span>folds.pred <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">conf_mat</span>(<span class="dt">truth =</span> label, .pred_class) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">summary =</span> <span class="kw">map</span>(conf_mat, summary)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(id, id2, fs, summary) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(folds.pred <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">mn_log_loss</span>(<span class="dt">truth =</span> label, .pred_Yes) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">mutate</span>(<span class="dt">.estimate =</span> <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.estimate))

<span class="co"># rank</span>
fs.rank &lt;-<span class="st"> </span>fs.summary <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> </span>metric<span class="op">$</span>.metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(fs, .metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">.estimate =</span> <span class="kw">mean</span>(.estimate)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(.metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rank =</span> <span class="kw">dense_rank</span>(<span class="kw">desc</span>(.estimate))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(rank)

<span class="co"># prep for ttest</span>
fs.test &lt;-<span class="st"> </span>fs.summary <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> </span>metric<span class="op">$</span>.metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(id, id2, fs, .metric, .estimate) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">spread</span>(fs, .estimate, <span class="dt">fill =</span> <span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(.metric, id, id2)

<span class="co"># ttest</span>
fs.ab &lt;-<span class="st"> </span><span class="kw">bayes_ttest</span>(fs.rank, <span class="st">&quot;fs&quot;</span>, fs.test, 
                        <span class="dt">.flds =</span> <span class="kw">length</span>(<span class="kw">unique</span>(fs.test<span class="op">$</span>id))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">map</span>(., <span class="op">~</span><span class="kw">gather</span>(., key, prob)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(<span class="dt">.id =</span> <span class="st">&quot;pair&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">equal.better =</span> <span class="kw">str_detect</span>(key, <span class="st">&quot;=|&gt;&quot;</span>),
         <span class="dt">equal.worse =</span> <span class="kw">str_detect</span>(key, <span class="st">&quot;=|&lt;&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(pair, equal.better) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">combined =</span> <span class="kw">sum</span>(prob)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(pair, equal.worse) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">less =</span> <span class="kw">sum</span>(prob)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>()<span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">separate</span>(key, <span class="kw">c</span>(<span class="st">&quot;better&quot;</span>, <span class="st">&quot;than&quot;</span>), 
           <span class="dt">sep =</span> <span class="st">&quot; &gt; | = | &lt;&quot;</span>, <span class="dt">remove =</span> F) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">better =</span> <span class="kw">str_trim</span>(better, <span class="st">&quot;both&quot;</span>),
         <span class="dt">than =</span> <span class="kw">str_trim</span>(than, <span class="st">&quot;both&quot;</span>))

<span class="co"># if second feature selection method performs similar to first</span>
<span class="co"># and has less variables </span>
<span class="co"># select second fs</span>
fs.same &lt;-<span class="st"> </span>fs.ab <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(pair <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(folds.vrs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">select</span>(<span class="dt">than =</span> fs,
                     <span class="dt">than.vrs =</span> vrs)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(folds.vrs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">select</span>(<span class="dt">better =</span> fs,
                     <span class="dt">better.vrs =</span> vrs)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">smaller =</span> than.vrs <span class="op">&lt;</span>better.vrs) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(prob)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">row_number</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span>
<span class="st">           </span><span class="kw">str_detect</span>(key, <span class="st">&quot;=&quot;</span>) <span class="op">&amp;</span>
<span class="st">           </span>smaller <span class="op">==</span><span class="st"> </span>T) 
  
<span class="co"># plot title</span>
fs.title &lt;-<span class="st"> </span><span class="kw">prose_title</span>(fs.ab, 
                        <span class="dt">.same =</span> fs.same, 
                        <span class="dt">.type =</span> <span class="st">&quot;feature selector&quot;</span>)

<span class="co"># selected fs ----</span>
fs &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">nrow</span>(fs.same) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, 
             fs.same<span class="op">$</span>than,
             fs.rank[fs.rank<span class="op">$</span>rank <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, ]<span class="op">$</span>fs)

fs.subtitle &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Average &quot;</span>,
                      <span class="kw">str_to_lower</span>(metric<span class="op">$</span>metric),
                      <span class="st">&quot; of &quot;</span>,
                      <span class="kw">round</span>(fs.rank[fs.rank<span class="op">$</span>fs <span class="op">==</span><span class="st"> </span>fs,
                                    ]<span class="op">$</span>.estimate, <span class="dv">3</span>) <span class="op">*</span><span class="dv">100</span>,
                      <span class="st">&quot;%&quot;</span>)

<span class="co"># plot</span>
fs.summary <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> </span>metric<span class="op">$</span>.metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(fs <span class="op">!=</span><span class="st"> </span>fs.rank[fs.rank<span class="op">$</span>rank <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(fs.rank<span class="op">$</span>rank),]<span class="op">$</span>fs) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">model =</span> fs) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">plot_folds</span>(., <span class="dt">.tlt =</span> fs.title, <span class="dt">.sbtlt =</span> fs.subtitle)</code></pre></div>
<p><img src="demo_files/figure-html/featureselection-1.png" width="576" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># no hyperparameters for glm</span>
folds.internal &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="co"># need dummy df as you can&#39;t create length 0 vectors</span>
  <span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;parameters&quot;</span> =<span class="st"> </span><span class="dv">0</span>))
  }<span class="cf">else</span>{
    <span class="co"># prep resamples</span>
    folds.internal.tn <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">mutate</span>(<span class="dt">analysis =</span> <span class="kw">map</span>(splits,
                        as.data.frame, <span class="dt">data =</span> <span class="st">&quot;analysis&quot;</span>),
               <span class="dt">assessment =</span> <span class="kw">map</span>(splits, as.data.frame, 
                                 <span class="dt">data =</span> <span class="st">&quot;assessment&quot;</span>),
               <span class="dt">assessment =</span> <span class="kw">map</span>(assessment, bind_rows,
                                assess.external[[<span class="dv">3</span>]]),
               <span class="dt">prep =</span> <span class="kw">map</span>(analysis, df_prep, <span class="dt">rec =</span> rec.all),
               <span class="dt">analysis =</span> <span class="kw">map2</span>(prep, analysis, bake),
               <span class="dt">assessment =</span> <span class="kw">map2</span>(prep, assessment, bake),
               <span class="dt">Formula =</span> <span class="kw">map</span>(prep, formula),
               <span class="dt">vrs =</span> <span class="kw">map</span>(analysis, <span class="op">~</span><span class="kw">select</span>(., <span class="op">-</span>Id, <span class="op">-</span>label)),
               <span class="dt">vrs =</span> <span class="kw">map</span>(vrs, colnames))
}

<span class="co"># apply selected fs</span>
folds.internal &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  folds.internal
  }<span class="cf">else</span>{
    <span class="cf">if</span>(fs <span class="op">==</span><span class="st"> &quot;Importance&quot;</span>){
       folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">         </span><span class="kw">select</span>(<span class="op">-</span>splits) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">         </span><span class="kw">mutate</span>(<span class="dt">vrs =</span> <span class="kw">map2</span>(analysis, Formula, var_imp),
                <span class="dt">form =</span> <span class="kw">map</span>(vrs, as_formula)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">         </span><span class="kw">select</span>(<span class="op">-</span>Formula)
      }<span class="cf">else</span>{
        <span class="cf">if</span>(fs <span class="op">==</span><span class="st"> &quot;Inclusive&quot;</span>){
          folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">            </span><span class="kw">select</span>(<span class="op">-</span>splits) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">            </span><span class="kw">mutate</span>(<span class="dt">Importance =</span>  <span class="kw">map2</span>(analysis, Formula, var_imp),
                   <span class="dt">Relevance =</span> <span class="kw">map2</span>(analysis, Formula, var_rel),
                   <span class="dt">Significance =</span> <span class="kw">map2</span>(analysis, vrs, var_sig),
                   <span class="dt">vrs =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(Importance,
                                   Relevance, 
                                   Significance), 
                              triple_u),
                   <span class="dt">form =</span> <span class="kw">map</span>(vrs, as_formula)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">            </span><span class="kw">select</span>(<span class="op">-</span>Formula)
          }<span class="cf">else</span>{
            <span class="cf">if</span>(fs <span class="op">==</span><span class="st"> &quot;Exclusive&quot;</span>){
              folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                </span><span class="kw">select</span>(<span class="op">-</span>splits) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                </span><span class="kw">mutate</span>(<span class="dt">Importance =</span>  <span class="kw">map2</span>(analysis, Formula,
                                          var_imp),
                       <span class="dt">Relevance =</span> <span class="kw">map2</span>(analysis, Formula, var_rel),
                       <span class="dt">Significance =</span> <span class="kw">map2</span>(analysis, vrs, var_sig),
                       <span class="dt">vrs =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(Importance,
                                       Relevance, 
                                       Significance),
                                  triple_inter),
                       <span class="dt">form =</span> <span class="kw">map</span>(vrs, as_formula))
              }<span class="cf">else</span>{
                <span class="cf">if</span>(fs <span class="op">==</span><span class="st"> &quot;Relevance&quot;</span>){
                  folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                    </span><span class="kw">select</span>(<span class="op">-</span>splits) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                    </span><span class="kw">mutate</span>(<span class="dt">vrs =</span> <span class="kw">map2</span>(analysis, Formula, var_rel),
                           <span class="dt">form =</span> <span class="kw">map</span>(vrs, as_formula)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                    </span><span class="kw">select</span>(<span class="op">-</span>Formula)
                  }<span class="cf">else</span>{
                    <span class="cf">if</span>(fs <span class="op">==</span><span class="st"> &quot;Significance&quot;</span>){
                      folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                        </span><span class="kw">select</span>(<span class="op">-</span>splits, <span class="op">-</span>Formula) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                        </span><span class="kw">mutate</span>(<span class="dt">vrs =</span> <span class="kw">map2</span>(analysis, vrs, var_sig),
                              <span class="dt">form =</span> <span class="kw">map</span>(vrs, as_formula))
                      }<span class="cf">else</span>{
                        folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                          </span><span class="kw">mutate</span>(<span class="dt">form =</span> Formula) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                          </span><span class="kw">select</span>(<span class="op">-</span>splits, <span class="op">-</span>Formula)
                      }
    }
    }
    }
  }
}

<span class="co"># number of predictors</span>
tn.cls &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
    <span class="kw">map_dbl</span>(folds.internal<span class="op">$</span>vrs, length)
}

<span class="co"># tuning parameter grid by model</span>
tune.grid &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
    <span class="kw">list</span>(<span class="st">&quot;RF&quot;</span> =<span class="st"> </span><span class="kw">grid_random</span>(mtry <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                            </span><span class="kw">range_set</span>(<span class="kw">c</span>(<span class="kw">floor</span>(<span class="kw">sqrt</span>(<span class="kw">min</span>(tn.cls))),
                                          <span class="kw">min</span>(tn.cls))),
                              min_n <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                               </span><span class="kw">range_set</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>)),
                             <span class="dt">size =</span> <span class="dv">9</span>),
         <span class="st">&quot;SVM&quot;</span> =<span class="st"> </span><span class="kw">grid_random</span>(cost, 
                             rbf_sigma,
                             <span class="dt">size =</span> <span class="dv">9</span>),
         <span class="st">&quot;XGB&quot;</span> =<span class="st"> </span><span class="kw">grid_random</span>(tree_depth, 
                             learn_rate <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                               </span><span class="kw">range_set</span>(<span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>)),
                                      <span class="dt">size =</span> <span class="dv">9</span>)
                  )
}

<span class="co"># clean model specs to merge with tuning parameters</span>
raw.mdls &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
    <span class="kw">list</span>(<span class="st">&quot;RF&quot;</span> =<span class="st"> </span><span class="kw">rand_forest</span>(<span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span>,
                               <span class="dt">mtry =</span> <span class="kw">varying</span>(),
                               <span class="dt">min_n =</span> <span class="kw">varying</span>(),
                               <span class="dt">trees =</span> <span class="dv">2000</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                   </span><span class="kw">set_engine</span>(<span class="st">&quot;ranger&quot;</span>,
                              <span class="dt">importance =</span> <span class="st">&quot;impurity&quot;</span>,
                              <span class="dt">probability =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                   </span><span class="kw">merge</span>(tune.grid[[<span class="st">&quot;RF&quot;</span>]]),
                 <span class="st">&quot;SVM&quot;</span> =<span class="st"> </span>
<span class="st">                   </span><span class="kw">svm_rbf</span>(<span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span>,
                           <span class="dt">rbf_sigma =</span> <span class="kw">varying</span>(),
                           <span class="dt">cost =</span> <span class="kw">varying</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                   </span><span class="kw">set_engine</span>(<span class="st">&quot;kernlab&quot;</span>,
                              <span class="dt">kernel =</span> <span class="st">&quot;rbfdot&quot;</span>,
                              <span class="dt">prob.model =</span> T) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                   </span><span class="kw">merge</span>(tune.grid[[<span class="st">&quot;SVM&quot;</span>]]),
                 <span class="st">&quot;XGB&quot;</span> =<span class="st"> </span>
<span class="st">                   </span><span class="kw">boost_tree</span>(<span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span>,
                              <span class="dt">mtry =</span> <span class="kw">.preds</span>(),
                              <span class="dt">learn_rate =</span> <span class="kw">varying</span>(),
                              <span class="dt">tree_depth =</span> <span class="kw">varying</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                   </span><span class="kw">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>,
                              <span class="dt">prob.model =</span> T) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                   </span><span class="kw">merge</span>(tune.grid[[<span class="st">&quot;XGB&quot;</span>]]))
}

<span class="co"># selected model with tuning grid</span>
<span class="co"># add on original model spec</span>
prs.mdls &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="kw">list</span>(models[[classifier]])
}<span class="cf">else</span>{
  <span class="kw">c</span>(raw.mdls[[classifier]],
    <span class="kw">list</span>(models[[classifier]]))
}

<span class="co"># fit to resamples, looping over tuning grid</span>
tunes &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">length</span>(prs.mdls))

<span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
<span class="cf">for</span>(i <span class="cf">in</span>(<span class="kw">seq_along</span>(prs.mdls))){
  tunes[[i]] &lt;-<span class="st"> </span>folds.internal <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">fit =</span> <span class="kw">map2</span>(analysis, form, prs_form,
                      <span class="dt">prs =</span> prs.mdls[[i]]),
           <span class="dt">fit =</span> <span class="kw">map2</span>(fit, assessment, predict, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>),
           <span class="dt">truth =</span> <span class="kw">map</span>(assessment, <span class="op">~</span><span class="kw">select</span>(., Id, label))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;id&quot;</span>), truth, fit)
  tunes
}
}

<span class="co"># bind rows of output</span>
tunes &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
    <span class="kw">bind_rows</span>(tunes, <span class="dt">.id =</span> <span class="st">&quot;tune&quot;</span>)
}

<span class="co"># to unnest list columns, df list-elements need equal rows</span>
<span class="co"># get row count by list element</span>
pads &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
    <span class="kw">map_dbl</span>(tunes<span class="op">$</span>truth, nrow)
}

<span class="co"># max row count</span>
pad.max &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
    <span class="kw">max</span>(pads)
}

<span class="co"># list of df to pad truth column</span>
pads.id &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">nrow</span>(folds.internal))

<span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
<span class="cf">for</span>(i <span class="cf">in</span>(<span class="kw">seq_along</span>(pads))){
  pads.id[[i]] &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;Id&quot;</span> =<span class="st"> </span>
<span class="st">                                   </span><span class="kw">rep</span>(<span class="st">&quot;0&quot;</span>, pad.max <span class="op">-</span><span class="st"> </span>pads[[i]])))
  pads.id
}
}

<span class="co"># list of df to pad prediction columns</span>
pads.pd &lt;-<span class="st">  </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">nrow</span>(folds.internal))

<span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
<span class="cf">for</span>(i <span class="cf">in</span>(<span class="kw">seq_along</span>(pads))){
  pads.pd[[i]] &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;.pred_Yes&quot;</span> =<span class="st"> </span>
<span class="st">                                   </span><span class="kw">rep</span>(<span class="dv">0</span>, pad.max <span class="op">-</span><span class="st"> </span>pads[[i]])))
  pads.pd
}
}

<span class="co"># apply hard class</span>
tunes &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
    tunes <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">truth =</span> <span class="kw">map2</span>(truth, pads.id, bind_rows),
             <span class="dt">fit =</span> <span class="kw">map2</span>(fit, pads.pd, bind_rows)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">.pred_class =</span> <span class="kw">ifelse</span>(.pred_Yes <span class="op">&gt;</span><span class="st"> </span>.pred_No, <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>),
             <span class="dt">.pred_class =</span> <span class="kw">factor</span>(.pred_class,
                              <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">filter</span>(Id <span class="op">!=</span><span class="st"> &quot;0&quot;</span>)
}

<span class="co"># summary metrics</span>
tunes.summary &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
    tunes <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">group_by</span>(tune, id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">classes =</span> <span class="kw">n_distinct</span>(.pred_class)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">filter</span>(classes <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">group_by</span>(id, tune) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">conf_mat</span>(<span class="dt">truth =</span> label, .pred_class) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">summary =</span> <span class="kw">map</span>(conf_mat, summary)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;id&quot;</span>), tune, summary) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">unnest</span>()<span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">bind_rows</span>(tunes <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                  </span><span class="kw">group_by</span>(tune, id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                  </span><span class="kw">mn_log_loss</span>(<span class="dt">truth =</span> label, .pred_Yes) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                  </span><span class="kw">mutate</span>(<span class="dt">.estimate =</span> <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.estimate))
}

<span class="co"># rank tunes</span>
tunes.rank &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
    tunes.summary <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> </span>metric<span class="op">$</span>.metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">group_by</span>(tune, .metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">summarize</span>(<span class="dt">.estimate =</span> <span class="kw">mean</span>(.estimate)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">group_by</span>(.metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">rank =</span> <span class="kw">dense_rank</span>(<span class="kw">desc</span>(.estimate))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">group_by</span>(tune, rank) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">summarize</span>(<span class="dt">ranks =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">group_by</span>(tune) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">filter</span>(ranks <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(ranks)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">arrange</span>(rank)
}

<span class="co"># prep for ttest</span>
tunes.test &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
    tunes.summary <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;id&quot;</span>), tune, .metric, .estimate) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">filter</span>(tune <span class="op">%in%</span><span class="st"> </span>tunes.rank<span class="op">$</span>tune) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> </span>metric<span class="op">$</span>.metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">spread</span>(tune, .estimate, <span class="dt">fill =</span> <span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">arrange</span>(id)
}

<span class="co"># ttest</span>
tunes.ab &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="ot">NA</span>
  }<span class="cf">else</span>{
    <span class="kw">bayes_ttest</span>(tunes.rank, <span class="st">&quot;tune&quot;</span>, tunes.test, 
                        <span class="dt">.flds =</span> <span class="kw">length</span>(<span class="kw">unique</span>(tunes.test<span class="op">$</span>id))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">map</span>(., <span class="op">~</span><span class="kw">gather</span>(., key, prob)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(<span class="dt">.id =</span> <span class="st">&quot;pair&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">equal.better =</span> <span class="kw">str_detect</span>(key, <span class="st">&quot;=|&gt;&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(pair, equal.better) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">combined =</span> <span class="kw">sum</span>(prob)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>()
  }
  
<span class="co"># selected tune</span>
selected.tune &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="dv">1</span>
  }<span class="cf">else</span>{
    <span class="kw">as.numeric</span>(tunes.rank[tunes.rank<span class="op">$</span>rank <span class="op">==</span>
<span class="st">                                         </span><span class="dv">1</span>,]<span class="op">$</span>tune)[<span class="dv">1</span>]
}

tune.prose &lt;-<span class="st"> </span><span class="cf">if</span>(classifier <span class="op">==</span><span class="st"> &quot;GLM&quot;</span>){
  <span class="st">&quot;There are no hyperparameters for general linear models&quot;</span>
}<span class="cf">else</span>{
  <span class="kw">paste0</span>(<span class="kw">length</span>(prs.mdls),
        <span class="st">&quot; candidate hyperparameter combinations were&quot;</span>,
        <span class="st">&quot; considered across &quot;</span>,
        <span class="kw">nrow</span>(folds.internal.tn), 
        <span class="st">&quot; datasets created from the third external fold.</span><span class="ch">\n</span><span class="st">&quot;</span>,
        <span class="st">&quot;The probability the selected hyperparameters outperform&quot;</span>, 
        <span class="st">&quot; the other options considered: &quot;</span>,
        <span class="kw">round</span>(tunes.ab[<span class="dv">1</span>,]<span class="op">$</span>combined,<span class="dv">2</span>)<span class="op">*</span><span class="dv">100</span>,
        <span class="st">&quot;%&quot;</span>)
}</code></pre></div>
<p>10 candidate hyperparameter combinations were considered across 5 datasets created from the third external fold. The probability the selected hyperparameters outperform the other options considered: 87%.</p>
</div>
</div>
<div id="model" class="section level1 tabset">
<h1>Model</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># prep entire training set</span>
prep.resample &lt;-<span class="st"> </span><span class="kw">prep</span>(rec.all, training, <span class="dt">strings_as_factors =</span> F) 

<span class="co"># bake training set</span>
train &lt;-<span class="st"> </span><span class="kw">bake</span>(prep.resample, training)

<span class="co"># bake test set</span>
test &lt;-<span class="st"> </span><span class="kw">bake</span>(prep.resample, <span class="kw">testing</span>(initial.split))

<span class="co"># bake scoring set</span>
score &lt;-<span class="st"> </span><span class="kw">bake</span>(prep.resample, <span class="kw">filter</span>(objs.model, <span class="kw">is.na</span>(label)))

<span class="co"># get all predictors</span>
train.all &lt;-<span class="st">  </span><span class="kw">summary</span>(prep.resample) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(role <span class="op">==</span><span class="st"> &quot;predictor&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(variable) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unlist</span>()

<span class="co"># apply fs</span>
train.vrs &lt;-<span class="st"> </span><span class="cf">if</span>(fs <span class="op">==</span><span class="st"> &quot;Importance&quot;</span>){
  out &lt;-<span class="st"> </span><span class="kw">var_imp</span>(train, <span class="kw">formula</span>(prep.resample))
}<span class="cf">else</span>{
  <span class="cf">if</span>(fs <span class="op">==</span><span class="st"> &quot;Relevance&quot;</span>){
    out &lt;-<span class="st"> </span><span class="kw">var_rel</span>(train, <span class="kw">formula</span>(prep.resample))
  }<span class="cf">else</span>{
    <span class="cf">if</span>(fs <span class="op">==</span><span class="st"> &quot;Significance&quot;</span>){
      out &lt;-<span class="st"> </span><span class="kw">var_sig</span>(train, train.all)
      }<span class="cf">else</span>{
        <span class="cf">if</span>(fs <span class="op">==</span><span class="st"> &quot;Exclusive&quot;</span>){
            imp &lt;-<span class="st"> </span><span class="kw">var_imp</span>(train, <span class="kw">formula</span>(prep.resample))
            br &lt;-<span class="st"> </span><span class="kw">var_rel</span>(train, <span class="kw">formula</span>(prep.resample))
            sg &lt;-<span class="st"> </span><span class="kw">var_sig</span>(train, train.all)
            out &lt;-<span class="st"> </span><span class="kw">intersect</span>(<span class="kw">intersect</span>(imp, br), <span class="kw">intersect</span>(br, sg))
        }<span class="cf">else</span>{
          <span class="cf">if</span>(fs <span class="op">==</span><span class="st"> &quot;Inclusive&quot;</span>){
            imp &lt;-<span class="st"> </span><span class="kw">var_imp</span>(train, <span class="kw">formula</span>(prep.resample))
            br &lt;-<span class="st"> </span><span class="kw">var_rel</span>(train, <span class="kw">formula</span>(prep.resample))
            sg &lt;-<span class="st"> </span><span class="kw">var_sig</span>(train, train.all)
            out &lt;-<span class="st"> </span><span class="kw">union</span>(imp, <span class="kw">union</span>(br, sg))
          }<span class="cf">else</span>{
        train.all
        }
        }
      }
  }
}

<span class="co"># create formula</span>
train.form &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>(<span class="st">&quot;label&quot;</span>, <span class="st">&quot;~&quot;</span>, 
                               <span class="kw">paste</span>(train.vrs, <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>)))

<span class="co"># fit model</span>
fits &lt;-<span class="st"> </span><span class="kw">q_f</span>(prs.mdls[[selected.tune]],
            train.form,
            train)[[<span class="st">&quot;result&quot;</span>]]

<span class="co"># generate test predictions</span>
test.preds &lt;-<span class="st"> </span>test <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span><span class="kw">c</span>(Id, label)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">probs =</span> <span class="kw">map</span>(data, df_pred, <span class="dt">.fit =</span> fits,
                     <span class="dt">.type =</span> <span class="st">&quot;prob&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Id, label, probs) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">.pred_class =</span> <span class="kw">ifelse</span>(.pred_Yes <span class="op">&gt;</span><span class="st"> </span>.pred_No, <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>),
         <span class="dt">.pred_class =</span> <span class="kw">factor</span>(.pred_class, 
                              <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">inner_join</span>(objs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">               </span><span class="kw">select</span>(Id, CreatedDate, LastActivityDate)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Correct =</span> <span class="kw">ifelse</span>(label <span class="op">==</span><span class="st"> </span>.pred_class, <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>),
         <span class="dt">YearCreated =</span> lubridate<span class="op">::</span><span class="kw">year</span>(CreatedDate),
         <span class="dt">YearActivity =</span> lubridate<span class="op">::</span><span class="kw">year</span>(LastActivityDate),
         <span class="dt">SameYear =</span> YearCreated <span class="op">==</span><span class="st"> </span>YearActivity)

<span class="co"># generate new predictions</span>
preds &lt;-<span class="st"> </span>score <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span><span class="kw">c</span>(Id, label)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">probs =</span> <span class="kw">map</span>(data, df_pred, <span class="dt">.fit =</span> fits, <span class="dt">.type =</span> <span class="st">&quot;prob&quot;</span>),
         <span class="dt">classes =</span> <span class="kw">map</span>(data, df_pred,
                       <span class="dt">.fit =</span> fits, <span class="dt">.type =</span> <span class="st">&quot;class&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Id, label, probs) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">.pred_class =</span> <span class="kw">ifelse</span>(.pred_Yes <span class="op">&gt;</span><span class="st"> </span>.pred_No, <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>),
         <span class="dt">.pred_class =</span> <span class="kw">factor</span>(.pred_class, 
                              <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">inner_join</span>(objs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">               </span><span class="kw">select</span>(Id, CreatedDate, LastActivityDate)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Decile =</span> <span class="kw">floor</span>(<span class="dv">10</span> <span class="op">*</span><span class="st"> </span>(.pred_Yes <span class="op">/</span><span class="st"> </span><span class="kw">max</span>(.pred_Yes))),
         <span class="dt">Decile =</span> <span class="kw">ifelse</span>(Decile <span class="op">==</span><span class="st"> </span><span class="dv">10</span>, <span class="dv">9</span>, Decile))

<span class="co"># test auc</span>
test.auc &lt;-<span class="st"> </span>test.preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">roc_auc</span>(<span class="dt">truth =</span> label, .pred_Yes)

<span class="co"># summary metrics</span>
test.metrics &lt;-<span class="st"> </span>test.preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">conf_mat</span>(<span class="dt">truth =</span> label, .pred_class) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summary</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(test.preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">gain_capture</span>(<span class="dt">truth =</span> label, .pred_Yes)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">bind_rows</span>(test.preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">pr_auc</span>(<span class="dt">truth =</span> label, .pred_Yes)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">bind_rows</span>(test.preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">roc_auc</span>(<span class="dt">truth =</span> label, .pred_Yes)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">bind_rows</span>(test.preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">mn_log_loss</span>(<span class="dt">truth =</span> label, .pred_Yes)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>.metric <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;sens&quot;</span>, <span class="st">&quot;spec&quot;</span>, <span class="st">&quot;recall&quot;</span>, <span class="st">&quot;precision&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Rate =</span> (<span class="kw">nrow</span>(test.preds[test.preds<span class="op">$</span>label <span class="op">==</span><span class="st"> &quot;Yes&quot;</span>,]) <span class="op">/</span>
<span class="st">                   </span><span class="kw">nrow</span>(test.preds)),
         <span class="dt">DetectionRate =</span> <span class="kw">nrow</span>(test.preds[test.preds<span class="op">$</span>label <span class="op">==</span><span class="st"> &quot;Yes&quot;</span> <span class="op">&amp;</span>
<span class="st">                                   </span>test.preds<span class="op">$</span>.pred_class <span class="op">==</span>
<span class="st">                                   &quot;Yes&quot;</span>,]) <span class="op">/</span><span class="st"> </span>(<span class="kw">nrow</span>(test.preds) <span class="op">*</span><span class="st"> </span><span class="dv">2</span>),
         <span class="dt">comp =</span> <span class="kw">metric_benchmark</span>(.metric, .estimate),
         <span class="dt">.estimate =</span> <span class="kw">round</span>(.estimate, <span class="dv">3</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">inner_join</span>(metric.table) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">good =</span> <span class="kw">case_when</span>(comp <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.95</span> <span class="op">~</span><span class="st"> &quot;No&quot;</span>,
                          comp <span class="op">&lt;</span><span class="st"> </span><span class="fl">1.1</span> <span class="op">~</span><span class="st"> &quot;Yes&quot;</span>,
                          comp <span class="op">&gt;=</span><span class="st"> </span><span class="fl">1.1</span> <span class="op">~</span><span class="st"> &quot;Great&quot;</span>))

vrs.prose &lt;-<span class="st"> </span><span class="kw">ifelse</span>(fs <span class="op">!=</span><span class="st"> &quot;All&quot;</span>,
                    <span class="kw">paste</span>(<span class="kw">length</span>(train.vrs), 
                          <span class="st">&quot;of&quot;</span>,
                          <span class="kw">length</span>(train.all),
                          <span class="st">&quot;predictors selected&quot;</span>,
                          <span class="st">&quot;by the&quot;</span>,
                          fs,
                          <span class="st">&quot;filter&quot;</span>),
                    <span class="kw">paste</span>(<span class="kw">length</span>(train.vrs),
                          <span class="st">&quot;predictors&quot;</span>))</code></pre></div>
<p><strong>Final Model:</strong> Xtreme Gradient Boosting using 37 of 66 predictors selected by the Inclusive filter.</p>
<div id="accuracy" class="section level2">
<h2>Accuracy</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># plot accuracy by year</span>
test.preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">YearCreated =</span> <span class="kw">factor</span>(YearCreated)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(YearCreated, Correct) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(YearCreated) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">total =</span> <span class="kw">sum</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rate =</span> <span class="kw">ifelse</span>(Correct <span class="op">==</span><span class="st"> &quot;No&quot;</span> <span class="op">&amp;</span><span class="st"> </span>total <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;&quot;</span>,
                       <span class="kw">paste0</span>(<span class="kw">round</span>(n <span class="op">/</span><span class="st"> </span>total, <span class="dv">2</span>)<span class="op">*</span><span class="dv">100</span>, <span class="st">&quot;%&quot;</span>)),
         <span class="dt">clr =</span> <span class="kw">ifelse</span>(total <span class="op">&lt;=</span><span class="st"> </span><span class="dv">3</span>, <span class="st">&quot;ble&quot;</span>, <span class="st">&quot;whte&quot;</span>),
         <span class="dt">nudge =</span> <span class="kw">ifelse</span>(total <span class="op">&lt;=</span><span class="st"> </span><span class="dv">3</span>, <span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> YearCreated, <span class="dt">y =</span> n))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw">fct_rev</span>(Correct)),
           <span class="dt">color =</span> <span class="st">&quot;#FFFFFF&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">x =</span> YearCreated,
                <span class="dt">y =</span> total <span class="op">+</span><span class="st"> </span>nudge, 
                <span class="dt">color =</span> clr,
                <span class="dt">label =</span> rate),
            <span class="dt">size =</span> <span class="dv">6</span>,
            <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>,
            <span class="dt">show.legend =</span> F)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Yes&quot;</span> =<span class="st"> &quot;#377EB8&quot;</span>,
                                <span class="st">&quot;No&quot;</span> =<span class="st"> &quot;#E41A1C&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;whte&quot;</span> =<span class="st"> &quot;#FFFFFF&quot;</span>,
                                <span class="st">&quot;ble&quot;</span> =<span class="st"> &quot;#132B43&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="st">&quot;Correct&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">paste0</span>(<span class="st">&quot;Test Prediction Accuracy: &quot;</span>,
                         <span class="kw">round</span>(test.metrics[test.metrics<span class="op">$</span>.metric <span class="op">==</span>
<span class="st">                                              &quot;accuracy&quot;</span>,
                                            ]<span class="op">$</span>.estimate, <span class="dv">2</span>)<span class="op">*</span><span class="dv">100</span>,
                         <span class="st">&quot;%&quot;</span>),
       <span class="dt">x =</span> <span class="st">&quot;Year Lead Created&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Predictions&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span>
          <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                       <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>))

<span class="co"># plot confusion matrix</span>
<span class="kw">conf_mat</span>(test.preds, label, .pred_class)[[<span class="dv">1</span>]] <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(Prediction, Truth))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">alpha =</span> n,
                <span class="dt">fill =</span> n),
            <span class="dt">show.legend =</span> F,
            <span class="dt">color =</span> <span class="st">&quot;grey50&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> n,
                <span class="dt">color =</span> n),
            <span class="dt">size =</span> <span class="dv">8</span>,
            <span class="dt">show.legend =</span> F,
            <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">paste</span>(<span class="st">&quot;Confusion Matrix:&quot;</span>,
                     <span class="kw">nrow</span>(test.preds[test.preds<span class="op">$</span>Correct <span class="op">==</span><span class="st"> &quot;Yes&quot;</span>,]),
                     <span class="st">&quot;of&quot;</span>,
                     <span class="kw">nrow</span>(test.preds),
                     <span class="st">&quot;test records correctly classified&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="dt">limits =</span> <span class="kw">c</span>(<span class="st">&quot;No&quot;</span>, <span class="st">&quot;Yes&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">limits =</span> <span class="kw">c</span>(<span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_continuous</span>(<span class="dt">low =</span> <span class="st">&quot;#56B1F7&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#132B43&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_continuous</span>(<span class="dt">low =</span> <span class="st">&quot;#132B43&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#56B1F7&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span>
          <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                       <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="fl">1.2</span>)))</code></pre></div>
<p><img src="demo_files/figure-html/testplots-1.png" width="45%" /><img src="demo_files/figure-html/testplots-2.png" width="45%" /></p>
</div>
<div id="performance-curves" class="section level2">
<h2>Performance Curves</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># plot performance curves</span>
test.preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">roc_curve</span>(<span class="dt">truth =</span> label, .pred_Yes) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">autoplot</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> test.metrics <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> &quot;j_index&quot;</span>),
            <span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">paste0</span>(metric, <span class="st">&quot;: &quot;</span>, .estimate),
                <span class="dt">color =</span> good,
                <span class="dt">x =</span> <span class="fl">0.65</span>,
                <span class="dt">y =</span> <span class="fl">0.2</span>),
            <span class="dt">size =</span> <span class="dv">6</span>,
            <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>,
            <span class="dt">show.legend =</span> F)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Yes&quot;</span> =<span class="st"> &quot;#377EB8&quot;</span>,
                                <span class="st">&quot;No&quot;</span> =<span class="st"> &quot;#E41A1C&quot;</span>,
                                <span class="st">&quot;Great&quot;</span> =<span class="st">  &quot;#4DAF4A&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;ROC&quot;</span>,
       <span class="dt">subtitle =</span> <span class="kw">paste0</span>(<span class="st">&quot;Area under curve&quot;</span>,
                        <span class="st">&quot;: &quot;</span>,
                        test.metrics[test.metrics<span class="op">$</span>.metric <span class="op">==</span>
<span class="st">                                       &quot;roc_auc&quot;</span>,]<span class="op">$</span>.estimate))<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span>
          <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                       <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="dv">1</span>)),
        <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),
        <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="fl">1.2</span>)))

test.preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pr_curve</span>(<span class="dt">truth =</span> label, .pred_Yes) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">autoplot</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> test.metrics <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> &quot;f_meas&quot;</span>),
            <span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">paste0</span>(metric, <span class="st">&quot;: &quot;</span>, .estimate),
                <span class="dt">color =</span> good,
                <span class="dt">x =</span> <span class="fl">0.3</span>,
                <span class="dt">y =</span> <span class="fl">0.2</span>),
            <span class="dt">size =</span> <span class="dv">6</span>,
            <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>,
            <span class="dt">show.legend =</span> F)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Yes&quot;</span> =<span class="st"> &quot;#377EB8&quot;</span>,
                                <span class="st">&quot;No&quot;</span> =<span class="st"> &quot;#E41A1C&quot;</span>,
                                <span class="st">&quot;Great&quot;</span> =<span class="st">  &quot;#4DAF4A&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Precision Recall Curve&quot;</span>,
       <span class="dt">subtitle =</span> <span class="kw">paste0</span>(<span class="st">&quot;Area under curve&quot;</span>,
                        <span class="st">&quot;: &quot;</span>,
                        test.metrics[test.metrics<span class="op">$</span>.metric <span class="op">==</span>
<span class="st">                                       &quot;pr_auc&quot;</span>,]<span class="op">$</span>.estimate))<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">ratio =</span> <span class="dv">1</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span>
          <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                       <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="dv">1</span>)),
        <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),
        <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="fl">1.2</span>)))

test.preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gain_curve</span>(<span class="dt">truth =</span> label, .pred_Yes) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">autoplot</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> test.metrics <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> &quot;gain_capture&quot;</span>),
            <span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">paste0</span>(metric, <span class="st">&quot;: &quot;</span>, .estimate),
                <span class="dt">color =</span> good,
                <span class="dt">x =</span> <span class="dv">70</span>,
                <span class="dt">y =</span> <span class="dv">20</span>),
            <span class="dt">size =</span> <span class="dv">6</span>,
            <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>,
            <span class="dt">show.legend =</span> F)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Yes&quot;</span> =<span class="st"> &quot;#377EB8&quot;</span>,
                                <span class="st">&quot;No&quot;</span> =<span class="st"> &quot;#E41A1C&quot;</span>,
                                <span class="st">&quot;Great&quot;</span> =<span class="st">  &quot;#4DAF4A&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Gain&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span>
          <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                       <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="dv">1</span>)),
        <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),
        <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="fl">1.2</span>)))

test.preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">lift_curve</span>(<span class="dt">truth =</span> label, .pred_Yes) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">autoplot</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> test.metrics <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> &quot;mn_log_loss&quot;</span>),
            <span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">paste0</span>(metric, <span class="st">&quot;: &quot;</span>, .estimate),
                <span class="dt">color =</span> good,
                <span class="dt">x =</span> <span class="dv">25</span>,
                <span class="dt">y =</span> <span class="fl">1.35</span>),
            <span class="dt">size =</span> <span class="dv">6</span>,
            <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>,
            <span class="dt">show.legend =</span> F)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Yes&quot;</span> =<span class="st"> &quot;#377EB8&quot;</span>,
                                <span class="st">&quot;No&quot;</span> =<span class="st"> &quot;#E41A1C&quot;</span>,
                                <span class="st">&quot;Great&quot;</span> =<span class="st">  &quot;#4DAF4A&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Lift&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span>
          <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                       <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="dv">1</span>)),
        <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),
        <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="fl">1.2</span>)))</code></pre></div>
<p><img src="demo_files/figure-html/testcurves-1.png" width="45%" /><img src="demo_files/figure-html/testcurves-2.png" width="45%" /><img src="demo_files/figure-html/testcurves-3.png" width="45%" /><img src="demo_files/figure-html/testcurves-4.png" width="45%" /></p>
</div>
<div id="variable-importance" class="section level2">
<h2>Variable Importance</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># calculate variable importance using each feature selector</span>
<span class="co"># combine and plot</span>
final.imp &lt;-<span class="st"> </span><span class="kw">final_imp</span>(train, train.vrs) 

final.lbl &lt;-<span class="st"> </span>final.imp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(variable) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">label =</span> <span class="kw">paste0</span>(<span class="st">&quot;feature&quot;</span>, <span class="kw">row_number</span>()))

final.imp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(final.lbl) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sze =</span> <span class="kw">ifelse</span>(selector <span class="op">==</span><span class="st"> </span>fs, <span class="dv">2</span>, <span class="dv">1</span>),
         <span class="dt">alph =</span> <span class="kw">ifelse</span>(selector <span class="op">==</span><span class="st"> </span>fs, <span class="dv">4</span><span class="op">/</span><span class="dv">5</span>, <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">fct_reorder</span>(label, value, <span class="dt">.fun =</span> max), value))<span class="op">+</span>
<span class="st">  </span><span class="kw">stat_summary</span>(<span class="dt">fun.data =</span> <span class="st">&quot;median_hilow&quot;</span>,
               <span class="dt">geom =</span> <span class="st">&quot;linerange&quot;</span>,
               <span class="dt">color =</span> <span class="st">&quot;#377EB8&quot;</span>,
               <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> selector,
                 <span class="dt">size =</span> sze,
                 <span class="dt">alpha =</span> alph))<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_size_area</span>(<span class="dt">max_size =</span> <span class="dv">3</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">color =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="ot">NULL</span>),
         <span class="dt">size =</span> <span class="st">&quot;none&quot;</span>,
         <span class="dt">alpha =</span> <span class="st">&quot;none&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Normalized Importance&quot;</span>,
       <span class="dt">x =</span> <span class="ot">NULL</span>,
       <span class="dt">y =</span> <span class="ot">NULL</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span>
          <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                       <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="fl">0.6</span>)))</code></pre></div>
<p><img src="demo_files/figure-html/varimp-1.png" width="576" /></p>
</div>
<div id="test-predictions" class="section level2">
<h2>Test Predictions</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># output to datatable</span>
DT<span class="op">::</span><span class="kw">datatable</span>(test.preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                </span><span class="kw">mutate</span>(<span class="dt">Probability =</span>
                         <span class="kw">format</span>(<span class="kw">round</span>(.pred_Yes, <span class="dt">digits =</span> <span class="dv">3</span>),
                                <span class="dt">nsmall =</span> <span class="dv">3</span>),
                       <span class="dt">Id =</span> <span class="kw">paste0</span>(<span class="st">&quot;Id...&quot;</span>,
                                   <span class="kw">str_sub</span>(Id, <span class="op">-</span><span class="dv">4</span>, <span class="op">-</span><span class="dv">1</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                </span><span class="kw">select</span>(Id, 
                       <span class="dt">Truth =</span> label,
                       <span class="dt">Prediction =</span> .pred_class, 
                       Probability,
                       CreatedDate, 
                       LastActivityDate) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                </span><span class="kw">arrange</span>(<span class="kw">desc</span>(Probability)),
              <span class="dt">options =</span> <span class="kw">list</span>(<span class="dt">columnDefs =</span> 
                               <span class="kw">list</span>(<span class="kw">list</span>(<span class="dt">className =</span>
                                           <span class="st">&#39;dt-center&#39;</span>,
                                     <span class="dt">targets =</span> <span class="dv">6</span>))))</code></pre></div>
<div id="htmlwidget-7030fa798c5175ef5297" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7030fa798c5175ef5297">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56"],["Id...wEAA","Id...tUAA","Id...9UAA","Id...MUAQ","Id...1UAA","Id...XEAS","Id...PEA4","Id...6UAC","Id...aEAM","Id...EEAY","Id...eUAM","Id...kEAG","Id...kUAA","Id...rEAC","Id...uUAC","Id...jUAI","Id...DUAV","Id...TUA5","Id...AUAQ","Id...EUA4","Id...VUAS","Id...RUA0","Id...YEA4","Id...LUA1","Id...lUAK","Id...8UAG","Id...MUAQ","Id...6EAC","Id...4UAE","Id...BUAW","Id...4EAK","Id...GUAW","Id...gUAL","Id...GUAV","Id...bUAM","Id...GUAT","Id...5UAF","Id...BUA4","Id...CUAT","Id...BUA0","Id...cUAK","Id...EEA4","Id...KUAR","Id...cUAC","Id...qUAN","Id...vUAN","Id...cUAG","Id...BUAW","Id...AUAR","Id...uUAC","Id...8UAG","Id...5UAM","Id...4UAG","Id...kUAC","Id...RUAW","Id...tUAC"],["Yes","Yes","No","Yes","Yes","No","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","No","No","Yes","No","Yes","No","Yes","No","No","No","No","Yes","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No"],["Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No"],["0.960","0.939","0.916","0.914","0.902","0.901","0.900","0.890","0.867","0.745","0.703","0.690","0.672","0.655","0.636","0.617","0.526","0.505","0.478","0.460","0.429","0.332","0.295","0.214","0.201","0.166","0.127","0.122","0.109","0.097","0.089","0.084","0.082","0.081","0.079","0.077","0.077","0.069","0.066","0.053","0.053","0.051","0.044","0.042","0.041","0.041","0.041","0.035","0.031","0.029","0.028","0.028","0.026","0.026","0.024","0.024"],["2018-11-13","2017-06-27","2017-09-25","2017-01-19","2017-01-13","2017-10-31","2019-01-31","2017-04-27","2017-10-23","2018-06-27","2017-06-07","2018-02-08","2017-06-27","2019-01-30","2017-07-07","2016-07-21","2016-02-24","2016-02-04","2017-09-25","2017-03-15","2017-07-07","2016-06-09","2018-01-02","2016-02-01","2016-12-09","2017-08-16","2017-01-13","2018-05-03","2016-10-10","2017-04-06","2017-12-05","2016-04-26","2016-04-20","2016-02-24","2017-01-23","2016-01-26","2016-02-24","2016-06-06","2016-01-26","2016-11-10","2017-04-22","2018-02-08","2016-03-28","2016-11-17","2016-03-10","2016-03-10","2016-05-03","2016-05-03","2016-03-28","2016-05-18","2016-05-03","2016-08-15","2016-06-06","2016-11-17","2016-05-03","2016-05-18"],["2018-12-12",null,"2017-10-04",null,null,"2017-11-03","2019-02-21",null,"2017-10-31","2018-06-29","2017-07-18","2018-11-06","2017-08-15",null,"2017-07-18",null,null,"2016-02-04","2017-09-27","2017-03-28","2017-08-15","2016-08-24",null,"2016-02-01",null,"2017-08-16","2017-01-13",null,null,null,"2017-12-05","2017-02-08","2017-02-08",null,"2017-01-23",null,null,"2016-08-24",null,"2017-04-03","2017-04-21","2018-02-16",null,"2017-01-16","2016-03-15",null,"2016-10-03","2016-10-03","2016-09-28","2016-05-16","2016-10-03","2016-08-15","2016-06-06","2017-04-03","2016-10-03","2016-05-16"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Id<\/th>\n      <th>Truth<\/th>\n      <th>Prediction<\/th>\n      <th>Probability<\/th>\n      <th>CreatedDate<\/th>\n      <th>LastActivityDate<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-center","targets":6},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="lead-scores" class="section level1 tabset tabset-pills">
<h1>Lead Scores</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># compute lift by decile</span>
mdl.lift.decile &lt;-<span class="st"> </span>test.preds <span class="op">%&gt;%</span>
<span class="st">  </span>yardstick<span class="op">::</span><span class="kw">lift_curve</span>(<span class="dt">truth =</span> label, .pred_Yes) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(.lift)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Percent =</span> <span class="dv">100</span> <span class="op">-</span><span class="st"> </span>.percent_tested) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(Percent)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Decile =</span> 
           <span class="kw">floor</span>(Percent <span class="op">/</span><span class="st"> </span><span class="dv">10</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(Decile) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(.lift <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(.lift)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">n</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span>
<span class="st">           </span><span class="kw">n</span>() <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span>
<span class="st">           </span>.n <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(.n)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Decile, .lift) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(Decile))

<span class="co"># prediction analysis ----</span>
<span class="co"># counts</span>
pred.counts &lt;-<span class="st"> </span>preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(.pred_class) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">Leads =</span> <span class="kw">n_distinct</span>(Id)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(conversions <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">filter</span>(Year <span class="op">==</span><span class="st"> </span><span class="dv">2019</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">select</span>(<span class="dt">.pred_class =</span> label,
                     Percent)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Expected =</span>
           <span class="kw">round</span>(Percent <span class="op">*</span><span class="kw">nrow</span>(score)))</code></pre></div>
<div id="range-of-predicted-values" class="section level2">
<h2>Range of Predicted Values</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># bucket predictions by probability and plot</span>
preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Strength =</span> <span class="kw">case_when</span>(.pred_Yes <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.8</span> <span class="op">~</span><span class="st"> &quot;Strong&quot;</span>,
                              .pred_Yes <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.6</span> <span class="op">~</span><span class="st"> &quot;Potential&quot;</span>,
                              .pred_Yes <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.4</span> <span class="op">~</span><span class="st"> &quot;Uncertain&quot;</span>,
                              .pred_Yes <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">~</span><span class="st"> &quot;Unlikely&quot;</span>,
                              .pred_Yes <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.0</span> <span class="op">~</span><span class="st"> &quot;Weak&quot;</span>),
         <span class="dt">Strength =</span> <span class="kw">factor</span>(Strength, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;Strong&quot;</span>,
                                                <span class="st">&quot;Potential&quot;</span>,
                                                <span class="st">&quot;Uncertain&quot;</span>,
                                                <span class="st">&quot;Unlikely&quot;</span>,
                                                <span class="st">&quot;Weak&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="kw">ggplot</span>(<span class="kw">aes</span>(.pred_Yes, <span class="dt">fill =</span> Strength))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>),
                 <span class="dt">color =</span> <span class="st">&quot;#FFFFFF&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;Weak&quot;</span> =<span class="st"> &quot;#E41A1C&quot;</span>,
                               <span class="st">&quot;Unlikely&quot;</span> =<span class="st"> &quot;#FB6A4A&quot;</span>,
                               <span class="st">&quot;Uncertain&quot;</span> =<span class="st"> &quot;grey60&quot;</span>,
                               <span class="st">&quot;Potential&quot;</span> =<span class="st"> &quot;#377EB8&quot;</span>,
                               <span class="st">&quot;Strong&quot;</span> =<span class="st"> &quot;#08519C&quot;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.2</span>),
                     <span class="dt">labels =</span> <span class="kw">as.character</span>(<span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.2</span>)))<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="ot">NULL</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">paste</span>(<span class="st">&quot;Range of conversion probabilities for&quot;</span>,
                      <span class="kw">nrow</span>(preds),
                      <span class="st">&quot;leads&quot;</span>),
       <span class="dt">x =</span> <span class="st">&quot;Probability&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Predictions&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span>
          <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                       <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>))</code></pre></div>
<p><img src="demo_files/figure-html/predrange-1.png" width="576" /></p>
</div>
<div id="increasing-conversion-rate" class="section level2">
<h2>Increasing Conversion Rate</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">top.deciles &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">9</span>, <span class="dv">8</span>)

<span class="co"># calculate improvement using by decile lift</span>
pred.score.deciles &lt;-<span class="st"> </span>preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Decile =</span> <span class="kw">ntile</span>(<span class="kw">row_number</span>(), <span class="dv">10</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(Decile) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">Leads =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(Decile)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">.n =</span> <span class="kw">cumsum</span>(Leads)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Decile =</span> Decile <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)

<span class="co"># expected conversion rate</span>
decile.expected &lt;-<span class="st"> </span>pred.score.deciles <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">expected.range =</span> 
             <span class="kw">map</span>(Leads,
      <span class="cf">function</span>(x){out &lt;-<span class="st"> </span>x <span class="op">*</span>
<span class="st">        </span>conversion.rate[conversion.rate<span class="op">$</span>Percent <span class="op">&gt;</span>
<span class="st">                          </span><span class="kw">min</span>(conversion.rate<span class="op">$</span>Percent),
                                             ]<span class="op">$</span>Percent})) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(Decile) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">expected.range =</span> <span class="kw">floor</span>(expected.range),
         <span class="dt">order =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(order) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(Decile), <span class="dt">.by_group =</span> T) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">.n_events =</span> <span class="kw">cumsum</span>(expected.range)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(.n) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">.n_min =</span> <span class="kw">min</span>(.n_events),
            <span class="dt">.n_max =</span> <span class="kw">max</span>(.n_events),
            <span class="dt">.n_events =</span> <span class="kw">floor</span>(<span class="kw">median</span>(.n_events))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(<span class="kw">tribble</span>(
   <span class="op">~</span>Decile, <span class="op">~</span>.n, <span class="op">~</span>.n_min, <span class="op">~</span>.n_max, <span class="op">~</span>.n_events,
    <span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>
  )) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Decile, .n, .n_min, .n_events, .n_max) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="st">&quot;Expected&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(.n)

decile.predicted &lt;-<span class="st"> </span>decile.expected <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Decile, <span class="kw">starts_with</span>(<span class="st">&quot;.n&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(key, value, <span class="op">-</span><span class="kw">c</span>(Decile, .n)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(mdl.lift.decile) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Expected =</span> <span class="kw">floor</span>(value <span class="op">*</span>.lift)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Decile, .n, key, Expected) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">spread</span>(key, Expected) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(.n_events)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(<span class="kw">tribble</span>(
    <span class="op">~</span>Decile, <span class="op">~</span>.n, <span class="op">~</span>.n_events, <span class="op">~</span>.n_min, <span class="op">~</span>.n_max,
    <span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>
  )) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Decile, .n, .n_min, .n_events, .n_max) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="st">&quot;Predicted&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(.n)

<span class="co"># plot axis labels</span>
ax &lt;-<span class="st"> </span>decile.predicted[decile.predicted<span class="op">$</span>Decile <span class="op">%in%</span>
<span class="st">                         </span>top.deciles, ]<span class="op">$</span>.n

<span class="co"># prep to plot</span>
decile.lift &lt;-<span class="st"> </span>decile.expected <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(decile.predicted) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(type) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(.n, <span class="dt">.by_group =</span> T) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gap =</span> .n_events <span class="op">-</span><span class="st"> </span><span class="kw">lag</span>(.n_events)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(Decile) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gap =</span> <span class="kw">min</span>(gap)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ndg =</span> <span class="fl">1.5</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(Decile <span class="op">%in%</span><span class="st"> </span>top.deciles)

conv.imp &lt;-<span class="st"> </span>decile.expected <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(.n_events <span class="op">&lt;</span><span class="st"> </span><span class="kw">max</span>(decile.lift<span class="op">$</span>.n_events)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(.n_events <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(.n_events))

decile.title &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">paste0</span>(<span class="st">&quot;Tesing indicates &quot;</span>,
          <span class="kw">round</span>(<span class="kw">mean</span>(mdl.lift.decile[mdl.lift.decile<span class="op">$</span>Decile <span class="op">%in%</span>
<span class="st">                         </span>top.deciles,]<span class="op">$</span>.lift)),
                       <span class="st">&quot;x lift for the top &quot;</span>,
                       (<span class="kw">length</span>(top.deciles) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)<span class="op">*</span><span class="dv">10</span>,
                          <span class="st">&quot;% &quot;</span>)
                       
decile.subtitle &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">paste</span>(<span class="st">&quot;The&quot;</span>,
          <span class="kw">max</span>(decile.predicted[decile.predicted<span class="op">$</span>Decile <span class="op">%in%</span>
<span class="st">                                              </span>top.deciles, ]<span class="op">$</span>.n),
        <span class="st">&quot;highest scoring leads&quot;</span>,
        <span class="st">&quot;should deliver</span><span class="ch">\n</span><span class="st">the same&quot;</span>, 
        <span class="st">&quot;conversions as&quot;</span>,
        conv.imp<span class="op">$</span>.n,
        <span class="st">&quot;leads&quot;</span>)

<span class="co"># plot</span>
<span class="kw">ggplot</span>(decile.lift, <span class="kw">aes</span>(.n, .n_events, <span class="dt">group =</span> type))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> .n_min,
                  <span class="dt">ymax =</span> .n_max,
                  <span class="dt">fill =</span> type),
              <span class="dt">alpha =</span> <span class="fl">0.35</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_path</span>(<span class="kw">aes</span>(<span class="dt">color =</span> type))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> decile.lift[decile.lift<span class="op">$</span>.n <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>,],
            <span class="kw">aes</span>(<span class="dt">label =</span> .n_events,
                <span class="dt">color =</span> type,
                <span class="dt">y =</span> .n_events <span class="op">+</span><span class="st"> </span>ndg),
            <span class="dt">size =</span> <span class="dv">4</span>,
            <span class="dt">hjust =</span> <span class="st">&quot;inward&quot;</span>,
            <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>,
            <span class="dt">show.legend =</span> F)<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">color =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="ot">NULL</span>, <span class="dt">reverse =</span> T),
         <span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="ot">NULL</span>, <span class="dt">reverse =</span> T))<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">paste</span>(decile.title),
       <span class="dt">subtitle =</span> <span class="kw">paste</span>(decile.subtitle),
       <span class="dt">x =</span> <span class="st">&quot;Leads&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Conversions&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> ax,
                     <span class="dt">labels =</span> <span class="kw">as.character</span>(ax))<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">legend.key =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>),
        <span class="dt">legend.key.size =</span> <span class="kw">unit</span>(<span class="dv">2</span>, <span class="st">&quot;lines&quot;</span>))</code></pre></div>
<p><img src="demo_files/figure-html/benefitPlot-1.png" width="576" /></p>
</div>
<div id="scores" class="section level2">
<h2>Scores</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># output to datatable</span>
DT<span class="op">::</span><span class="kw">datatable</span>(preds <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                </span><span class="kw">mutate</span>(<span class="dt">Score =</span> 
                         <span class="kw">format</span>(<span class="kw">round</span>(.pred_Yes <span class="op">/</span>
<span class="st">                                        </span><span class="kw">max</span>(.pred_Yes), 
                                      <span class="dt">digits =</span> <span class="dv">3</span>), 
                                <span class="dt">nsmall =</span> <span class="dv">3</span>),
                       <span class="dt">Probability =</span>
                         <span class="kw">format</span>(<span class="kw">round</span>(.pred_Yes, <span class="dt">digits =</span> <span class="dv">3</span>),
                                <span class="dt">nsmall =</span> <span class="dv">3</span>),
                       <span class="dt">Id =</span> <span class="kw">paste0</span>(<span class="st">&quot;Id...&quot;</span>,
                                   <span class="kw">str_sub</span>(Id, <span class="op">-</span><span class="dv">4</span>, <span class="op">-</span><span class="dv">1</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                </span><span class="kw">select</span>(Id, 
                       <span class="dt">Prediction =</span> .pred_class, 
                       Score, 
                       Probability,
                       CreatedDate, 
                       LastActivityDate) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                </span><span class="kw">arrange</span>(<span class="kw">desc</span>(Score)),
              <span class="dt">caption =</span> <span class="st">&quot;Scores&quot;</span>,
              <span class="dt">options =</span> <span class="kw">list</span>(<span class="dt">columnDefs =</span> 
                               <span class="kw">list</span>(<span class="kw">list</span>(<span class="dt">className =</span>
                                           <span class="st">&#39;dt-center&#39;</span>,
                                     <span class="dt">targets =</span> <span class="dv">6</span>))))</code></pre></div>
<div id="htmlwidget-67e513984fcee7b3db0b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-67e513984fcee7b3db0b">{"x":{"filter":"none","caption":"<caption>Scores<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297"],["Id...zEAI","Id...zEAI","Id...nEAK","Id...REA4","Id...REA2","Id...eEAE","Id...dEAI","Id...XEAU","Id...kEAI","Id...hEAI","Id...KEAY","Id...SEAS","Id...cEAM","Id...DEA0","Id...IUA0","Id...GUAW","Id...XEAQ","Id...gEAI","Id...qEAC","Id...2UAI","Id...nUAA","Id...7EAC","Id...lEAG","Id...HEA0","Id...2UAA","Id...KEAS","Id...LUAY","Id...yEAC","Id...BEAY","Id...pUAI","Id...TEA0","Id...dEAA","Id...SEAQ","Id...6UAA","Id...8EAC","Id...UEAS","Id...9UAA","Id...BEA0","Id...kUAG","Id...6EAI","Id...OUAQ","Id...YUA2","Id...nEAG","Id...sEAG","Id...yUAI","Id...aUAE","Id...gUAC","Id...iUAC","Id...oEAE","Id...3UAA","Id...fEAE","Id...WUAQ","Id...fUAA","Id...UUAU","Id...nUAA","Id...LUAQ","Id...oEAG","Id...7UAA","Id...lUAA","Id...cUAC","Id...XUAS","Id...CEA4","Id...5UAO","Id...SUA0","Id...FUA0","Id...eUAK","Id...cEAM","Id...eUAA","Id...YEAY","Id...TEAY","Id...1UAA","Id...QEAU","Id...rUAA","Id...VUAS","Id...5UAD","Id...qUAA","Id...8UAA","Id...VUAQ","Id...QUAQ","Id...qUAC","Id...5UAC","Id...mUAB","Id...kEAK","Id...7UAC","Id...mUAG","Id...fUAA","Id...CUAQ","Id...fUAI","Id...KEAQ","Id...mEAK","Id...DUAS","Id...7UAA","Id...UUAQ","Id...ZUAQ","Id...OUAQ","Id...IUAY","Id...jUAG","Id...mUAE","Id...KUAQ","Id...CUAW","Id...4UAA","Id...sUAK","Id...DUAV","Id...0UAF","Id...FUAY","Id...VEA4","Id...DUAW","Id...iUAG","Id...6UAM","Id...2UAA","Id...7UAB","Id...JUA4","Id...qUAI","Id...1UAO","Id...KUA4","Id...MEAW","Id...FUAQ","Id...8EAC","Id...6UAA","Id...ZUAU","Id...CUAU","Id...JUAS","Id...NUA4","Id...cUAM","Id...LUAW","Id...2UAG","Id...MUA2","Id...IUA4","Id...SEA2","Id...RUA4","Id...tUAC","Id...oUAA","Id...0UAE","Id...EEAS","Id...rUAC","Id...AUAQ","Id...MUA4","Id...MUAS","Id...6UAG","Id...LUA2","Id...8UAA","Id...6EAC","Id...NUA2","Id...GUAS","Id...CUA2","Id...0UAC","Id...YUAQ","Id...FUA2","Id...jEAK","Id...KUA2","Id...DEAS","Id...rUAC","Id...GUAW","Id...LEAW","Id...5UAC","Id...nUAO","Id...kUAC","Id...vUAG","Id...AUAQ","Id...9UAA","Id...2UAG","Id...oUAA","Id...PUAQ","Id...fUAO","Id...EUAQ","Id...9UAC","Id...CUAS","Id...cUAI","Id...WUAS","Id...LUA4","Id...JUAY","Id...QUA2","Id...vUAE","Id...oUAA","Id...vUAO","Id...HUAQ","Id...SUA2","Id...IUA4","Id...GUA0","Id...PUA2","Id...VUA2","Id...dUAA","Id...nUAO","Id...iUAE","Id...fEAA","Id...OUAS","Id...HUAV","Id...TUA2","Id...OUA4","Id...PUA4","Id...5UAO","Id...xUAO","Id...LUAQ","Id...yUAE","Id...AUAQ","Id...JUA0","Id...9UAC","Id...IUAQ","Id...aUAA","Id...HUAQ","Id...UUA4","Id...MUAQ","Id...bUAC","Id...FUAW","Id...XUAT","Id...vUAF","Id...xUAF","Id...8UAF","Id...FUAV","Id...qUAG","Id...5UAN","Id...wUAK","Id...7UAA","Id...MUA0","Id...6UAK","Id...HUAS","Id...DUAU","Id...lUAI","Id...ZUAY","Id...ZUA4","Id...DUAQ","Id...FUAQ","Id...NUA1","Id...nUAN","Id...SUA2","Id...tEAG","Id...8UAC","Id...3EAG","Id...BUAQ","Id...TUA4","Id...TUAS","Id...RUAQ","Id...wEAI","Id...JUAW","Id...NUAQ","Id...JUAV","Id...OUAV","Id...mUAN","Id...sUAN","Id...8UAN","Id...AUA3","Id...IUA3","Id...UUA4","Id...yUAC","Id...DUAS","Id...8UAG","Id...KUAV","Id...NUAV","Id...iUAC","Id...hUAC","Id...rUAN","Id...0UAN","Id...CUA3","Id...GUA3","Id...kUAN","Id...MUA3","Id...TUAV","Id...TUAS","Id...zUAC","Id...iUAC","Id...rUAO","Id...IUAV","Id...LUAV","Id...MUAV","Id...SUAV","Id...aUAF","Id...FUAW","Id...GUAW","Id...lUAC","Id...JUAS","Id...OUAS","Id...XUAS","Id...8UAC","Id...AUAS","Id...oUAC","Id...EUAS","Id...5UAC","Id...tUAC","Id...6UAC","Id...9UAC","Id...uUAC","Id...ZUAS","Id...1UAF","Id...XUAV","Id...CUAS","Id...RUAS","Id...6UAC","Id...vUAE","Id...5UAB","Id...eUAC","Id...VUAS","Id...FUAS","Id...uUAC","Id...4UAC","Id...vUAC","Id...EUAW","Id...wUAE"],["Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","Yes","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No","No"],["1.000","0.992","0.989","0.986","0.985","0.985","0.985","0.981","0.974","0.974","0.974","0.970","0.967","0.962","0.945","0.944","0.942","0.942","0.942","0.928","0.924","0.922","0.920","0.916","0.915","0.915","0.914","0.912","0.906","0.900","0.899","0.892","0.888","0.882","0.877","0.869","0.867","0.863","0.854","0.845","0.839","0.830","0.828","0.819","0.818","0.809","0.807","0.801","0.797","0.792","0.780","0.771","0.769","0.762","0.761","0.754","0.752","0.749","0.742","0.741","0.732","0.731","0.728","0.727","0.712","0.712","0.702","0.688","0.685","0.685","0.684","0.663","0.658","0.656","0.650","0.646","0.640","0.623","0.618","0.617","0.607","0.603","0.602","0.596","0.586","0.560","0.558","0.555","0.548","0.540","0.530","0.520","0.517","0.513","0.509","0.502","0.493","0.491","0.491","0.490","0.488","0.485","0.471","0.467","0.466","0.460","0.452","0.452","0.427","0.413","0.409","0.404","0.401","0.390","0.385","0.385","0.375","0.375","0.370","0.368","0.364","0.364","0.342","0.336","0.325","0.314","0.314","0.302","0.297","0.296","0.292","0.280","0.269","0.264","0.259","0.257","0.256","0.246","0.235","0.234","0.233","0.233","0.212","0.208","0.205","0.204","0.200","0.198","0.198","0.195","0.189","0.186","0.186","0.181","0.177","0.175","0.171","0.171","0.168","0.166","0.163","0.156","0.152","0.151","0.149","0.147","0.147","0.147","0.142","0.138","0.133","0.132","0.127","0.118","0.115","0.115","0.115","0.113","0.113","0.113","0.111","0.109","0.105","0.105","0.103","0.102","0.099","0.098","0.096","0.096","0.096","0.096","0.096","0.095","0.094","0.092","0.092","0.092","0.089","0.089","0.087","0.086","0.083","0.082","0.079","0.079","0.079","0.079","0.079","0.079","0.077","0.077","0.077","0.076","0.076","0.074","0.073","0.072","0.072","0.071","0.071","0.071","0.069","0.067","0.066","0.066","0.064","0.063","0.060","0.059","0.059","0.057","0.057","0.055","0.055","0.051","0.051","0.050","0.050","0.050","0.050","0.050","0.050","0.048","0.048","0.045","0.043","0.043","0.043","0.043","0.042","0.042","0.042","0.042","0.042","0.042","0.042","0.041","0.040","0.037","0.037","0.036","0.036","0.036","0.036","0.036","0.036","0.036","0.035","0.034","0.033","0.032","0.032","0.032","0.032","0.032","0.032","0.032","0.032","0.032","0.032","0.031","0.030","0.030","0.030","0.029","0.029","0.029","0.028","0.027","0.027","0.027","0.027","0.027","0.027","0.025","0.025"],["0.968","0.960","0.957","0.955","0.954","0.954","0.954","0.950","0.943","0.943","0.943","0.939","0.937","0.932","0.915","0.914","0.912","0.912","0.912","0.898","0.895","0.893","0.891","0.887","0.886","0.886","0.885","0.883","0.877","0.872","0.871","0.863","0.859","0.854","0.850","0.842","0.839","0.836","0.827","0.819","0.812","0.804","0.802","0.793","0.792","0.784","0.782","0.776","0.771","0.767","0.755","0.746","0.745","0.738","0.736","0.730","0.728","0.725","0.718","0.718","0.709","0.708","0.705","0.704","0.689","0.689","0.680","0.666","0.663","0.663","0.662","0.642","0.637","0.636","0.630","0.625","0.620","0.603","0.599","0.598","0.587","0.584","0.583","0.577","0.568","0.543","0.541","0.537","0.530","0.523","0.513","0.504","0.500","0.497","0.493","0.486","0.477","0.475","0.475","0.474","0.473","0.469","0.456","0.452","0.451","0.446","0.438","0.438","0.413","0.400","0.396","0.391","0.389","0.377","0.372","0.373","0.363","0.363","0.359","0.356","0.353","0.353","0.331","0.326","0.315","0.304","0.304","0.292","0.288","0.286","0.283","0.271","0.260","0.255","0.250","0.249","0.248","0.238","0.228","0.227","0.226","0.226","0.205","0.202","0.198","0.198","0.193","0.192","0.192","0.189","0.183","0.180","0.180","0.175","0.171","0.170","0.165","0.166","0.163","0.161","0.158","0.151","0.147","0.147","0.144","0.143","0.143","0.143","0.138","0.133","0.129","0.127","0.123","0.114","0.111","0.112","0.112","0.110","0.109","0.110","0.107","0.106","0.102","0.101","0.100","0.099","0.096","0.095","0.093","0.093","0.093","0.093","0.093","0.092","0.091","0.089","0.089","0.089","0.086","0.086","0.084","0.084","0.080","0.079","0.077","0.077","0.077","0.077","0.077","0.077","0.074","0.074","0.074","0.074","0.074","0.072","0.070","0.070","0.070","0.069","0.069","0.069","0.067","0.065","0.064","0.064","0.062","0.061","0.058","0.057","0.058","0.056","0.055","0.053","0.053","0.050","0.050","0.048","0.048","0.048","0.048","0.048","0.048","0.047","0.047","0.044","0.042","0.042","0.042","0.042","0.041","0.041","0.041","0.041","0.041","0.041","0.041","0.039","0.039","0.036","0.036","0.035","0.035","0.035","0.035","0.035","0.035","0.035","0.034","0.033","0.032","0.031","0.031","0.031","0.031","0.031","0.031","0.031","0.031","0.031","0.031","0.030","0.029","0.029","0.029","0.028","0.028","0.028","0.027","0.026","0.026","0.026","0.026","0.026","0.026","0.024","0.024"],["2018-12-14","2018-12-03","2019-01-28","2019-02-04","2018-12-19","2019-03-20","2019-03-22","2019-03-20","2019-03-22","2019-03-22","2019-03-22","2017-12-05","2017-10-23","2018-01-22","2017-07-27","2017-07-06","2018-03-26","2018-03-29","2018-09-21","2017-06-20","2017-06-27","2018-09-21","2017-11-03","2019-01-10","2017-06-27","2018-09-06","2017-06-29","2017-11-27","2018-05-11","2017-05-25","2018-10-03","2018-05-08","2018-06-27","2017-05-22","2017-10-31","2018-02-21","2017-06-20","2018-01-16","2017-07-14","2018-05-11","2017-06-28","2017-06-07","2018-02-08","2018-02-08","2017-06-21","2017-09-07","2017-07-07","2017-07-01","2018-03-08","2017-06-20","2017-10-25","2017-05-25","2017-06-27","2017-02-28","2017-05-03","2017-06-20","2018-02-08","2017-06-27","2017-05-03","2017-07-07","2016-09-09","2017-12-21","2017-08-24","2017-08-30","2017-07-27","2017-07-29","2018-06-13","2017-06-27","2018-06-22","2018-06-22","2017-06-27","2018-06-06","2017-06-27","2017-07-07","2016-01-25","2017-06-27","2017-05-03","2017-06-20","2017-05-11","2017-03-14","2017-07-11","2016-02-18","2017-11-08","2016-09-08","2017-07-14","2017-01-19","2017-06-20","2017-06-29","2018-06-18","2019-01-22","2017-07-07","2017-09-25","2017-06-20","2017-06-20","2017-06-20","2017-06-28","2017-07-14","2017-02-28","2017-06-20","2017-03-17","2017-06-27","2017-08-08","2016-03-02","2016-03-10","2017-05-03","2017-11-02","2017-07-14","2017-07-14","2017-06-08","2017-03-03","2016-03-28","2016-06-06","2017-10-10","2016-06-06","2016-06-06","2018-02-08","2017-06-20","2019-01-26","2017-03-06","2017-02-28","2017-05-30","2017-07-07","2016-06-06","2016-07-27","2016-08-30","2016-08-30","2017-06-07","2016-06-06","2017-10-23","2016-06-06","2017-03-14","2017-06-20","2016-10-10","2017-10-31","2016-11-17","2017-06-20","2016-06-06","2017-03-14","2017-08-16","2017-06-07","2017-01-13","2019-01-24","2017-06-07","2016-09-13","2017-01-24","2016-11-17","2016-06-30","2017-06-07","2019-01-22","2017-06-07","2017-10-31","2017-03-14","2017-03-24","2018-02-08","2017-04-27","2016-11-15","2016-11-17","2017-08-11","2017-01-26","2017-01-13","2016-12-06","2017-01-19","2017-05-04","2016-06-06","2017-01-13","2016-11-17","2016-11-17","2017-05-04","2016-11-10","2016-06-06","2017-05-04","2017-06-07","2017-02-27","2017-01-19","2017-01-09","2017-01-13","2017-06-07","2016-06-06","2016-09-14","2017-02-09","2017-06-07","2017-10-16","2016-06-06","2017-01-13","2018-03-01","2016-09-09","2016-03-11","2017-06-07","2016-06-06","2016-06-06","2016-06-06","2016-06-06","2016-10-26","2016-10-10","2017-01-13","2016-09-19","2016-11-17","2017-06-20","2017-06-20","2017-06-20","2016-04-26","2017-06-20","2017-04-19","2016-08-30","2016-01-26","2016-02-24","2016-02-24","2016-02-24","2016-02-24","2016-11-05","2016-03-10","2017-04-14","2017-09-10","2016-09-20","2017-04-14","2016-11-17","2017-02-17","2017-01-19","2017-01-19","2016-06-06","2017-01-13","2017-01-19","2016-04-20","2016-03-10","2017-05-20","2018-04-13","2017-04-27","2018-04-13","2017-01-13","2016-06-06","2016-11-17","2017-01-19","2018-06-27","2016-04-26","2017-05-10","2016-04-08","2016-04-08","2016-03-10","2016-03-10","2016-03-10","2016-03-10","2016-03-10","2016-06-06","2016-11-17","2016-11-17","2017-04-06","2016-04-08","2016-04-08","2016-09-08","2016-09-08","2016-03-10","2016-03-10","2016-03-10","2016-03-10","2016-03-10","2016-03-10","2016-04-08","2016-11-17","2016-11-17","2016-11-17","2017-03-16","2016-04-08","2016-04-08","2016-04-08","2016-04-08","2016-04-08","2016-04-26","2016-04-26","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-04-08","2016-04-08","2016-11-17","2016-11-17","2016-11-17","2017-02-28","2016-03-28","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-11-17","2016-06-06","2017-02-28"],["2018-12-14",null,"2019-01-30","2019-02-21","2018-12-20","2019-03-20","2019-03-22","2019-03-25","2019-03-22","2019-03-25","2019-03-22","2018-04-17","2017-10-25","2018-01-22",null,"2017-07-14","2018-07-30","2018-03-29","2018-09-21","2018-01-18","2017-12-07","2018-09-21","2018-01-11","2019-01-10",null,"2018-09-06","2018-01-29","2017-12-04","2018-05-16","2017-08-14","2018-10-03","2019-03-20","2018-06-27","2017-06-27","2018-06-26","2019-01-30","2017-06-28","2018-04-17","2017-07-19","2018-05-16","2017-07-14",null,"2018-03-27","2018-06-07","2017-06-28","2017-09-14","2017-07-07",null,"2018-03-22","2017-08-15","2017-10-31","2017-05-30",null,null,"2017-05-05","2017-06-26","2018-06-22","2017-07-10","2017-05-12","2017-10-20","2017-06-30","2017-12-21","2017-09-29","2017-10-05","2017-10-20",null,"2018-06-13","2017-07-10",null,"2018-06-22","2017-06-28","2019-01-29","2017-10-20","2017-07-11","2016-09-20","2017-06-28","2017-06-20","2017-10-20","2017-05-15","2017-03-24","2019-02-25","2016-02-18","2019-03-20","2016-07-04","2017-07-14","2017-01-20","2017-07-27","2017-07-14","2018-06-18","2019-01-22","2017-08-15","2018-06-22","2017-06-21","2017-06-28","2017-06-26","2017-06-28","2017-07-14","2017-03-07","2017-06-28","2017-06-27","2017-08-15","2018-03-07","2016-03-25",null,"2019-01-10",null,null,"2017-07-14","2017-06-08","2018-06-20","2016-06-30","2016-06-21","2017-10-10","2016-06-10","2016-06-13",null,"2018-04-04","2019-01-30","2017-03-06",null,"2017-06-13","2017-07-11","2016-06-10",null,null,"2016-09-01","2017-06-19","2016-06-07","2017-12-07","2016-06-07","2017-03-21","2017-06-26","2016-12-07","2018-02-19","2016-11-17","2017-06-28","2016-06-10","2017-04-07","2017-08-16","2017-06-19","2017-01-12","2019-01-25","2018-02-05","2016-09-13","2017-03-28","2018-08-14",null,null,"2019-01-29","2017-06-07","2017-11-15","2017-03-24",null,null,"2017-09-06","2016-11-15","2016-12-14","2017-08-16","2018-11-15","2017-01-23","2016-12-08","2017-01-20","2018-06-20","2016-06-13","2017-10-31","2016-12-22",null,"2017-05-08","2016-11-10","2016-06-10","2017-05-08","2018-01-22","2017-02-27","2017-02-24","2017-01-13","2017-01-17",null,"2016-06-21","2016-09-22","2017-02-27",null,"2017-10-16",null,"2017-01-23","2018-03-01","2016-09-13","2016-03-11",null,null,"2016-06-10",null,null,"2016-10-26","2017-01-20","2017-01-20","2016-09-22","2016-11-22","2017-06-21","2017-10-20","2017-06-26","2016-04-27","2017-06-26","2017-09-18","2016-09-27","2016-04-21",null,null,null,null,"2016-11-09",null,"2018-01-29","2017-09-10","2016-09-22","2018-01-29","2016-12-22","2017-02-23","2017-01-20","2017-01-20",null,"2017-01-20","2017-01-23","2016-05-06","2016-04-21","2017-05-20","2018-04-11","2017-10-20","2018-04-11","2017-10-31","2016-06-10",null,"2017-02-27","2018-06-28","2016-08-26","2017-07-14","2016-04-12","2016-05-04","2016-06-21",null,"2016-04-21",null,null,null,null,"2016-11-18","2017-04-18",null,null,"2016-09-13","2017-07-04",null,null,"2016-04-21","2016-04-21","2016-05-04",null,"2016-06-21","2016-11-22","2016-12-14","2016-12-04","2017-04-03","2016-05-04","2016-04-12","2016-05-13","2016-05-13","2016-05-13","2016-06-21","2016-05-04","2016-11-22","2016-11-21",null,null,"2017-01-06","2016-12-22","2017-04-03","2016-11-21",null,"2017-01-06","2017-01-09","2016-12-14","2016-12-22","2017-05-15","2017-01-11",null,"2016-11-22","2016-12-22","2016-11-21","2017-07-14","2016-06-30",null,null,"2017-03-17","2017-05-15","2016-12-14","2016-12-22",null,"2017-02-28"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Id<\/th>\n      <th>Prediction<\/th>\n      <th>Score<\/th>\n      <th>Probability<\/th>\n      <th>CreatedDate<\/th>\n      <th>LastActivityDate<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-center","targets":6},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="feature-engineering" class="section level1 tabset tabset-pills">
<h1>Feature Engineering</h1>
<div id="labels" class="section level2">
<h2>Labels</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># label count</span>
objs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">label =</span> <span class="kw">case_when</span>(<span class="kw">is.na</span>(label) <span class="op">~</span><span class="st"> &quot;Scoring&quot;</span>,
                           label <span class="op">==</span><span class="st"> &quot;Yes&quot;</span> <span class="op">~</span><span class="st"> &quot;Yes&quot;</span>,
                           label <span class="op">==</span><span class="st"> &quot;No&quot;</span> <span class="op">~</span><span class="st"> &quot;No&quot;</span>),
         <span class="dt">label =</span> <span class="kw">factor</span>(label, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;No&quot;</span>,
                                          <span class="st">&quot;Yes&quot;</span>,
                                          <span class="st">&quot;Scoring&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(label))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> label), <span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>,
           <span class="dt">color =</span> <span class="st">&quot;#FFFFFF&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="st">&quot;none&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> 
         <span class="kw">paste0</span>(<span class="st">&quot;No: Status is Unqualified</span><span class="ch">\n</span><span class="st">&quot;</span>,
                <span class="st">&quot;Yes: IsConverted is TRUE or Status is Qualified/&quot;</span>,
               <span class="st">&quot;Sales Active</span><span class="ch">\n</span><span class="st">&quot;</span>,
               <span class="st">&quot;Scoring: Status is Open, Marketing F/U or Contacted&quot;</span>),
       <span class="dt">x =</span> <span class="ot">NULL</span>,
       <span class="dt">y =</span> <span class="st">&quot;Leads&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">legend.key =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>),
        <span class="dt">strip.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">color =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">panel.spacing =</span> <span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">&quot;lines&quot;</span>),
        <span class="dt">legend.key.size =</span> <span class="kw">unit</span>(<span class="dv">2</span>, <span class="st">&quot;lines&quot;</span>))</code></pre></div>
<p><img src="demo_files/figure-html/labelsPlot-1.png" width="576" /></p>
</div>
<div id="indicators" class="section level2">
<h2>Indicators</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># binary predictors</span>
objs.model <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Set =</span> <span class="kw">ifelse</span>(Id <span class="op">%in%</span><span class="st"> </span>score<span class="op">$</span>Id,
                      <span class="st">&quot;Predict&quot;</span>, <span class="st">&quot;Train&quot;</span>),
         <span class="dt">Set =</span> <span class="kw">factor</span>(Set, <span class="dt">levels =</span> 
                        <span class="kw">c</span>(<span class="st">&quot;Train&quot;</span>, <span class="st">&quot;Predict&quot;</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(Set, KnownURL, PublicDomain) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(key, value, <span class="op">-</span>Set) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(value))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Set), <span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>,
           <span class="dt">color =</span> <span class="st">&quot;#FFFFFF&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="ot">NULL</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> 
         <span class="kw">paste0</span>(<span class="st">&quot;KnownURL: is first contact URL known</span><span class="ch">\n</span><span class="st">&quot;</span>,
               <span class="st">&quot;PublicDomain: is email domain one of &quot;</span>,
               <span class="kw">length</span>(public.domains),  <span class="st">&quot; public domains&quot;</span>),
       <span class="dt">x =</span> <span class="ot">NULL</span>,
       <span class="dt">y =</span> <span class="st">&quot;Leads&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>key,
             <span class="dt">ncol =</span> <span class="dv">2</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">position =</span> <span class="st">&quot;right&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">legend.key =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>),
        <span class="dt">strip.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">panel.spacing =</span> <span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">&quot;lines&quot;</span>))</code></pre></div>
<p><img src="demo_files/figure-html/indicatorPlot-1.png" width="576" /></p>
</div>
<div id="date-variables" class="section level2">
<h2>Date Variables</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># date predictors</span>
objs.model <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Set =</span> <span class="kw">ifelse</span>(Id <span class="op">%in%</span><span class="st"> </span>score<span class="op">$</span>Id,
                      <span class="st">&quot;Predict&quot;</span>, <span class="st">&quot;Train&quot;</span>),
         <span class="dt">Set =</span> <span class="kw">factor</span>(Set, <span class="dt">levels =</span> 
                        <span class="kw">c</span>(<span class="st">&quot;Train&quot;</span>, <span class="st">&quot;Predict&quot;</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(Set, <span class="kw">contains</span>(<span class="st">&quot;Age&quot;</span>), <span class="kw">contains</span>(<span class="st">&quot;Activity&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(key, value, <span class="op">-</span>Set) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">key =</span> <span class="kw">str_remove_all</span>(key, <span class="st">&quot;NUM&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(value))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Set),
           <span class="dt">color =</span> <span class="st">&quot;#FFFFFF&quot;</span>, 
                 <span class="dt">bins =</span>
                   <span class="kw">floor</span>(<span class="kw">sum</span>(<span class="op">!</span><span class="kw">is.na</span>(objs.model<span class="op">$</span>label))<span class="op">/</span><span class="dv">20</span>),
                 <span class="dt">show.legend =</span> F)<span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(key<span class="op">~</span>Set,
             <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> 
         <span class="kw">paste0</span>(<span class="st">&quot;Activity Days: days between first &quot;</span>, 
               <span class="st">&quot;&amp; last activity</span><span class="ch">\n</span><span class="st">&quot;</span>,
               <span class="st">&quot;Age: days between creation &quot;</span>,
               <span class="st">&quot;&amp; conversion/today</span><span class="ch">\n</span><span class="st">&quot;</span>,
               <span class="st">&quot;Last Activity: days between last &quot;</span>,
               <span class="st">&quot;activity &amp; conversion/today&quot;</span>),
       <span class="dt">x =</span> <span class="st">&quot;Days&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Leads&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">legend.key =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>),
        <span class="dt">strip.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">strip.text.y =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">0</span>),
        <span class="dt">panel.spacing =</span> <span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">&quot;lines&quot;</span>))</code></pre></div>
<p><img src="demo_files/figure-html/dayPlots-1.png" width="576" /></p>
</div>
<div id="level-aggregation" class="section level2 tabset">
<h2>Level Aggregation</h2>
<p>Original responses suppressed</p>
<div id="leadsource" class="section level3">
<h3>LeadSource</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># leadsource reduction</span>
ls &lt;-<span class="st"> </span>obj <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Id, LeadSource) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Source =</span> <span class="kw">token_freq</span>(LeadSource),
         <span class="dt">Source =</span> <span class="kw">fct_lump</span>(Source, <span class="dt">prop =</span> <span class="fl">0.05</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(LeadSource))

ls <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">fct_rev</span>(<span class="kw">fct_infreq</span>(LeadSource))))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Source))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">labels =</span> <span class="kw">rep</span>(<span class="st">&quot;&quot;</span>, <span class="kw">length</span>(<span class="kw">unique</span>(ls<span class="op">$</span>LeadSource))))<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> 
         <span class="kw">paste</span>(<span class="kw">length</span>(<span class="kw">unique</span>(ls<span class="op">$</span>LeadSource)),
               <span class="st">&quot;levels aggregated to&quot;</span>,
               <span class="kw">length</span>(<span class="kw">unique</span>(ls<span class="op">$</span>Source))),
       <span class="dt">x =</span> <span class="ot">NULL</span>,
       <span class="dt">y =</span> <span class="st">&quot;Leads&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="st">&quot;none&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(<span class="dt">rows =</span>
               <span class="kw">vars</span>(<span class="kw">fct_rev</span>(<span class="kw">fct_infreq</span>(<span class="kw">str_sub</span>(Source, <span class="dv">1</span>, <span class="dv">3</span>)))), 
             <span class="dt">scales =</span> <span class="st">&quot;free_y&quot;</span>, 
             <span class="dt">space =</span> <span class="st">&quot;free&quot;</span>,
             <span class="dt">as.table =</span> F)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">legend.key =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>),
        <span class="dt">legend.key.size =</span> <span class="kw">unit</span>(<span class="dv">1</span>, <span class="st">&quot;lines&quot;</span>),
        <span class="dt">strip.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">strip.text.y =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">0</span>),
        <span class="dt">panel.spacing =</span> <span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">&quot;lines&quot;</span>))</code></pre></div>
<p><img src="demo_files/figure-html/sourcePlot-1.png" width="576" /></p>
</div>
<div id="product-service-interest" class="section level3">
<h3>Product Service Interest</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># interest reduction</span>
ps &lt;-<span class="st"> </span>obj <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Id, Product_Service_Interest__c) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Interest =</span> <span class="kw">token_freq</span>(Product_Service_Interest__c),
         <span class="dt">Interest =</span> <span class="kw">fct_lump</span>(Interest, <span class="dt">prop =</span> <span class="fl">0.05</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(Product_Service_Interest__c))

ps <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">fct_rev</span>(<span class="kw">fct_infreq</span>(Product_Service_Interest__c))))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Interest))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_discrete</span>(
    <span class="dt">labels =</span> <span class="kw">rep</span>(<span class="st">&quot;&quot;</span>,
                  <span class="kw">length</span>(<span class="kw">unique</span>(ps<span class="op">$</span>Product_Service_Interest__c)))
    )<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> 
         <span class="kw">paste</span>(<span class="kw">length</span>(<span class="kw">unique</span>(ps<span class="op">$</span>Product_Service_Interest__c)),
           <span class="st">&quot;levels aggregated to&quot;</span>,
        <span class="kw">length</span>(<span class="kw">unique</span>(ps<span class="op">$</span>Interest))),
       <span class="dt">x =</span> <span class="ot">NULL</span>,
       <span class="dt">y =</span> <span class="st">&quot;Leads&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="st">&quot;none&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(<span class="dt">rows =</span> 
               <span class="kw">vars</span>(<span class="kw">fct_rev</span>(<span class="kw">fct_infreq</span>(<span class="kw">str_sub</span>(Interest, <span class="dv">1</span>, <span class="dv">3</span>)))),
             <span class="dt">scales =</span> <span class="st">&quot;free_y&quot;</span>, 
             <span class="dt">space =</span> <span class="st">&quot;free&quot;</span>,
             <span class="dt">as.table =</span> F)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">legend.key =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>),
        <span class="dt">legend.key.size =</span> <span class="kw">unit</span>(<span class="dv">1</span>, <span class="st">&quot;lines&quot;</span>),
        <span class="dt">strip.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">strip.text.y =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">0</span>),
        <span class="dt">panel.spacing =</span> <span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">&quot;lines&quot;</span>))</code></pre></div>
<p><img src="demo_files/figure-html/interestPlot-1.png" width="576" /></p>
</div>
<div id="title" class="section level3">
<h3>Title</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># title reduction</span>
titles &lt;-<span class="st"> </span>objs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Set =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(label),
                      <span class="st">&quot;Predict&quot;</span>, <span class="st">&quot;Train&quot;</span>),
         <span class="dt">Set =</span> <span class="kw">factor</span>(Set, <span class="dt">levels =</span>
                        <span class="kw">c</span>(<span class="st">&quot;Train&quot;</span>, <span class="st">&quot;Predict&quot;</span>)),
         <span class="dt">TitleDM =</span> <span class="kw">token_freq</span>(Title),
         <span class="dt">TitleDM =</span> <span class="kw">fct_lump</span>(TitleDM, <span class="dt">prop =</span> <span class="fl">0.05</span>))

titles <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">fct_rev</span>(<span class="kw">fct_infreq</span>(TitleDM))))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Set), <span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>,
           <span class="dt">color =</span> <span class="st">&quot;#FFFFFF&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> 
         <span class="kw">paste</span>(<span class="kw">length</span>(<span class="kw">unique</span>(titles<span class="op">$</span>Title)),
               <span class="st">&quot;levels aggregated to&quot;</span>,
               <span class="kw">length</span>(<span class="kw">unique</span>(titles<span class="op">$</span>TitleDM))),
       <span class="dt">x =</span> <span class="ot">NULL</span>,
       <span class="dt">y =</span> <span class="st">&quot;Records&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="ot">NULL</span>, <span class="dt">reverse =</span> T))<span class="op">+</span>
<span class="st"> </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">legend.key =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>),
        <span class="dt">legend.key.size =</span> <span class="kw">unit</span>(<span class="dv">1</span>, <span class="st">&quot;lines&quot;</span>))</code></pre></div>
<p><img src="demo_files/figure-html/rolePlot-1.png" width="576" /></p>
</div>
<div id="email" class="section level3">
<h3>Email</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># create predictors from email</span>
objs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Set =</span> <span class="kw">ifelse</span>(Id <span class="op">%in%</span><span class="st"> </span>score<span class="op">$</span>Id,
                      <span class="st">&quot;Predict&quot;</span>, <span class="st">&quot;Train&quot;</span>),
         <span class="dt">Set =</span> <span class="kw">factor</span>(Set, <span class="dt">levels =</span>
                        <span class="kw">c</span>(<span class="st">&quot;Train&quot;</span>, <span class="st">&quot;Predict&quot;</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">fct_rev</span>(<span class="kw">fct_infreq</span>(EmailSuffix))))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Set), <span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>,
           <span class="dt">color =</span> <span class="st">&quot;#FFFFFF&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span>  
         <span class="kw">paste</span>(<span class="kw">nrow</span>(obj),
               <span class="st">&quot;levels aggregated to&quot;</span>,
               <span class="kw">length</span>(<span class="kw">unique</span>(objs.model<span class="op">$</span>EmailSuffixDM))),
       <span class="dt">x =</span> <span class="ot">NULL</span>,
       <span class="dt">y =</span> <span class="st">&quot;Records&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="ot">NULL</span>, <span class="dt">reverse =</span> T))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set2&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>,
                                        <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">legend.key =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>),
        <span class="dt">legend.key.size =</span> <span class="kw">unit</span>(<span class="dv">1</span>, <span class="st">&quot;lines&quot;</span>))</code></pre></div>
<p><img src="demo_files/figure-html/suffixPlot-1.png" width="576" /></p>
</div>
</div>
<div id="variable-interactions" class="section level2">
<h2>Variable Interactions</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># breakdown predictors</span>
vrs.tbl &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;vrs&quot;</span> =<span class="st"> </span>train.vrs)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">base =</span> <span class="kw">str_remove_all</span>(vrs, <span class="st">&quot;_.*$&quot;</span>),
         <span class="dt">base =</span> <span class="kw">str_remove_all</span>(base, <span class="st">&quot;NUM|DM&quot;</span>),
         <span class="dt">base2 =</span> <span class="kw">ifelse</span>(<span class="kw">str_detect</span>(vrs, <span class="st">&quot;_x_&quot;</span>),
                        <span class="kw">str_remove_all</span>(vrs, <span class="st">&quot;^.*_x_&quot;</span>),
                        <span class="ot">NA</span>),
         <span class="dt">base2 =</span> <span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.na</span>(base2),
                        <span class="kw">str_remove_all</span>(base2, <span class="st">&quot;_.*$&quot;</span>),
                        <span class="ot">NA</span>),
         <span class="dt">base2 =</span> <span class="kw">str_remove_all</span>(base2 ,<span class="st">&quot;NUM|DM&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">vrs.id =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">inner_join</span>(<span class="kw">map_dfr</span>(train[,train.vrs], max) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">               </span><span class="kw">gather</span>(vrs, size))

<span class="co"># combine list of interactions</span>
vrs.level &lt;-<span class="st"> </span>vrs.tbl <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(base2)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(base, vrs, vrs.id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(vrs.tbl <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(base2)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">select</span>(<span class="dt">base =</span> base2, 
                     vrs,
                     vrs.id)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(base) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">size =</span> <span class="kw">n</span>())

int.selected &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">str_detect</span>(train.vrs, <span class="st">&quot;_x_&quot;</span>))

int.per &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">round</span>((int.selected <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(train.vrs))<span class="op">*</span><span class="dv">100</span>),
                  <span class="st">&quot;% of predictors were interactions&quot;</span>)

<span class="co"># adjacency matrix converted to graph</span>
vrs.mat &lt;-<span class="st">  </span>vrs.level <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(vrs, base, size) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">spread</span>(vrs, size, <span class="dt">fill =</span> <span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">column_to_rownames</span>(<span class="st">&quot;base&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">data.matrix</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as_tbl_graph</span>(<span class="dt">directed =</span> T)

vrs.nodes &lt;-<span class="st"> </span>vrs.mat <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">activate</span>(<span class="st">&quot;nodes&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">id =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(vrs.tbl <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">select</span>(<span class="dt">name =</span> vrs, size))

vrs.edges &lt;-<span class="st"> </span>vrs.mat <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">activate</span>(<span class="st">&quot;edges&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(vrs.nodes <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">              </span><span class="kw">select</span>(<span class="dt">from =</span> id,
                     name))

vrs.mat &lt;-<span class="st"> </span>vrs.mat <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">activate</span>(<span class="st">&quot;edges&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">base =</span> vrs.edges<span class="op">$</span>name) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">activate</span>(<span class="st">&quot;nodes&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">base =</span> <span class="op">!</span>name <span class="op">%in%</span><span class="st"> </span>vrs.level<span class="op">$</span>vrs,
         <span class="dt">size =</span> vrs.nodes<span class="op">$</span>size) 

<span class="co"># base variable colors</span>
base.pal &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;ActivityDays&quot;</span> =<span class="st"> &quot;#377EB8&quot;</span>,
              <span class="st">&quot;Age&quot;</span> =<span class="st"> &quot;#E41A1C&quot;</span>,
              <span class="st">&quot;Campaign&quot;</span> =<span class="st"> &quot;#FF7F00&quot;</span>,
              <span class="st">&quot;EmailSuffix&quot;</span> =<span class="st"> &quot;#984EA3&quot;</span>,
              <span class="st">&quot;Interest&quot;</span> =<span class="st"> &quot;#E78AC3&quot;</span> ,
              <span class="st">&quot;LastActivity&quot;</span>  =<span class="st"> &quot;#A65628&quot;</span>,
              <span class="st">&quot;LeadSource&quot;</span> =<span class="st"> &quot;#4DAF4A&quot;</span>,
              <span class="st">&quot;PardotScore&quot;</span> =<span class="st"> &quot;#66C2A5&quot;</span>,
              <span class="st">&quot;Quarter&quot;</span> =<span class="st"> &quot;#80B1D3&quot;</span>,
              <span class="st">&quot;Role&quot;</span> =<span class="st"> &quot;#E78AC3&quot;</span>)</code></pre></div>
<p>57% of predictors were interactions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># plot network</span>
vrs.mat <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">node_is_isolated</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggraph</span>(<span class="dt">layout =</span> <span class="st">&quot;igraph&quot;</span>, 
         <span class="dt">algorithm =</span> <span class="st">&quot;nicely&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_edge_fan</span>(<span class="kw">aes</span>(<span class="dt">start_cap =</span> <span class="kw">label_rect</span>(base),
                    <span class="dt">color =</span> base,
                    <span class="dt">alpha =</span> ..index..),
                <span class="dt">show.legend =</span> F)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="kw">aes</span>(<span class="dt">filter =</span> type,
                      <span class="dt">size =</span> size,
                      <span class="dt">alpha =</span> size),
                  <span class="dt">shape =</span> <span class="dv">21</span>,
                  <span class="dt">show.legend =</span> F)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_node_text</span>(<span class="kw">aes</span>(<span class="dt">filter =</span> base,
                      <span class="dt">label =</span> name, 
                      <span class="dt">color =</span> name),
                 <span class="dt">size =</span> <span class="dv">2</span>,
                 <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>, 
                 <span class="dt">show.legend =</span> F)<span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">edge_color =</span><span class="st">&quot;none&quot;</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_size_area</span>(<span class="dt">max_size =</span> <span class="fl">1.5</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_edge_color_manual</span>(<span class="dt">values =</span> base.pal)<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> base.pal)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.margin =</span> <span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="st">&quot;lines&quot;</span>))</code></pre></div>
<p><img src="demo_files/figure-html/graph-1.png" width="576" /></p>
</div>
</div>
<div id="r" class="section level1 tabset">
<h1>R</h1>
<div id="session-info" class="section level2">
<h2>Session Info</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># session info</span>
<span class="kw">print</span>(<span class="kw">sessionInfo</span>())</code></pre></div>
<pre><code>## R version 3.5.1 (2018-07-02)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows 7 x64 (build 7601) Service Pack 1
## 
## Matrix products: default
## 
## locale:
## [1] LC_COLLATE=English_United States.1252 
## [2] LC_CTYPE=English_United States.1252   
## [3] LC_MONETARY=English_United States.1252
## [4] LC_NUMERIC=C                          
## [5] LC_TIME=English_United States.1252    
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] forcats_0.3.0        stringr_1.3.1        purrr_0.3.1         
##  [4] readr_1.1.1          tibble_2.0.1         tidyverse_1.2.1     
##  [7] dials_0.0.2          scales_1.0.0         rsample_0.0.4       
## [10] tidyr_0.8.3          yardstick_0.0.2.9000 recipes_0.1.4.9000  
## [13] dplyr_0.8.0.1        parsnip_0.0.1        ggraph_1.0.2        
## [16] ggplot2_3.0.0        tidygraph_1.1.1      Boruta_6.0.0        
## [19] xgboost_0.82.1       kernlab_0.9-27       ranger_0.10.1       
## [22] RForcecom_1.1       
## 
## loaded via a namespace (and not attached):
##  [1] nlme_3.1-137       bitops_1.0-6       lubridate_1.7.4   
##  [4] httr_1.3.1         tools_3.5.1        backports_1.1.2   
##  [7] R6_2.2.2           rpart_4.1-13       lazyeval_0.2.1    
## [10] colorspace_1.3-2   nnet_7.3-12        withr_2.1.2       
## [13] tidyselect_0.2.5   gridExtra_2.3      curl_3.2          
## [16] compiler_3.5.1     cli_1.0.1          rvest_0.3.2       
## [19] xml2_1.2.0         digest_0.6.17      rmarkdown_1.12    
## [22] pkgconfig_2.0.2    htmltools_0.3.6    rlang_0.3.1       
## [25] readxl_1.1.0       rstudioapi_0.7     farver_1.1.0      
## [28] generics_0.0.2     jsonlite_1.5       RCurl_1.95-4.11   
## [31] magrittr_1.5       Matrix_1.2-14      Rcpp_1.0.0        
## [34] munsell_0.5.0      viridis_0.5.1      stringi_1.2.4     
## [37] pROC_1.13.0        yaml_2.2.0         MASS_7.3-50       
## [40] plyr_1.8.4         grid_3.5.1         ggrepel_0.8.0     
## [43] crayon_1.3.4       lattice_0.20-35    haven_1.1.2       
## [46] splines_3.5.1      hms_0.4.2          knitr_1.22        
## [49] pillar_1.3.1       igraph_1.2.2       XML_3.98-1.16     
## [52] glue_1.3.0         evaluate_0.13      data.table_1.11.6 
## [55] modelr_0.1.2       tweenr_1.0.0       cellranger_1.1.0  
## [58] gtable_0.2.0       assertthat_0.2.0   xfun_0.5          
## [61] ggforce_0.1.3      gower_0.2.0        prodlim_2018.04.18
## [64] broom_0.5.0        class_7.3-14       survival_2.42-3   
## [67] viridisLite_0.3.0  timeDate_3043.102  units_0.6-1       
## [70] lava_1.6.3         ipred_0.9-8</code></pre>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
